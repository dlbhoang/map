<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>á»¨ng dá»¥ng Váº½ Tuyáº¿n Ä‘Æ°á»ng NÃ¢ng cao</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  ></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    #map {
      height: 100vh;
      width: 100%;
    }
    
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 300px;
      max-height: 90vh;
      overflow-y: auto;
      transition: all 0.3s ease;
    }
    
    /* Responsive cho Ä‘iá»‡n thoáº¡i */
    @media (max-width: 768px) {
      .control-panel {
        max-width: calc(100vw - 20px);
        max-height: 80vh;
        padding: 12px;
        font-size: 14px;
      }
      
      .control-panel h3 {
        font-size: 16px;
        margin-bottom: 12px;
      }
      
      .input-group label {
        font-size: 12px;
      }
      
      .input-group input, .input-group select {
        padding: 10px;
        font-size: 14px;
      }
      
      .btn {
        padding: 10px 8px;
        font-size: 11px;
        min-width: 70px;
      }
      
      .button-group {
        gap: 3px;
        margin: 8px 0;
      }
      
      .map-style-selector {
        top: 5px;
        right: 5px;
        padding: 8px;
      }
      
      .map-style-selector select {
        font-size: 12px;
        padding: 6px;
      }
      
      .legend {
        bottom: 60px;
        right: 10px;
        max-width: 200px;
        padding: 8px;
      }
      
      .status-bar {
        bottom: 5px;
        right: 5px;
        max-width: calc(100vw - 20px);
        font-size: 11px;
        padding: 6px 10px;
      }
    }
    
    /* áº¨n control panel trÃªn Ä‘iá»‡n thoáº¡i khi khÃ´ng cáº§n thiáº¿t */
    .control-panel.collapsed {
      transform: translateX(-100%);
      opacity: 0;
    }
    
    .control-panel h3 {
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #007cbf;
      padding-bottom: 5px;
    }
    
    .input-group {
      margin: 10px 0;
    }
    
    .input-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }
    
    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 13px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #007cbf;
    }
    
    .button-group {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
      flex: 1;
      min-width: 80px;
      touch-action: manipulation;
    }
    
    .btn-primary {
      background: #007cbf;
      color: white;
    }
    
    .btn-primary:hover {
      background: #005a8b;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #1e7e34;
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    
    .btn-warning {
      background: #ffc107;
      color: #212529;
    }
    
    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-1px);
    }
    
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    
    .btn-info:hover {
      background: #138496;
      transform: translateY(-1px);
    }
    
    .btn.active {
      box-shadow: 0 0 0 2px rgba(0,124,191,0.3);
    }
    
    .route-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border-left: 4px solid #007cbf;
    }
    
    .route-info h4 {
      margin-bottom: 5px;
      color: #333;
    }
    
    .route-info p {
      margin: 3px 0;
      font-size: 12px;
      color: #666;
    }
    
    .map-style-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .legend {
      position: absolute;
      bottom: 80px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 250px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
      font-size: 12px;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid #333;
    }
    
    /* CSS cho label Ä‘á»™ng */
    .label-icon {
      pointer-events: none;
    }
    
    .label-icon div {
      pointer-events: auto;
      transition: all 0.3s ease;
    }
    
    .label-icon div:hover {
      transform: scale(1.05) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important;
    }
    
    .status-bar {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 12px;
      max-width: 300px;
      word-wrap: break-word;
    }
    
    /* Biá»ƒu tÆ°á»£ng phÆ°Æ¡ng tiá»‡n di chuyá»ƒn */
    .vehicle-marker {
      position: absolute;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: bold;
      z-index: 1001;
      transition: all 0.3s ease;
      animation: vehicleBounce 1s infinite alternate;
    }
    
    /* Icon cho tá»«ng loáº¡i phÆ°Æ¡ng tiá»‡n */
    .vehicle-person {
      background: linear-gradient(135deg, #4CAF50, #45a049);
    }
    
    .vehicle-car {
      background: linear-gradient(135deg, #2196F3, #1976D2);
    }
    
    .vehicle-motorcycle {
      background: linear-gradient(135deg, #FF9800, #F57C00);
    }
    
    .vehicle-bicycle {
      background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    }
    
    .vehicle-bus {
      background: linear-gradient(135deg, #FF5722, #D84315);
    }
    
    .vehicle-truck {
      background: linear-gradient(135deg, #607D8B, #455A64);
    }
    
    .vehicle-ambulance {
      background: linear-gradient(135deg, #F44336, #D32F2F);
      animation: ambulanceFlash 1s infinite alternate;
    }
    
    .vehicle-police {
      background: linear-gradient(135deg, #3F51B5, #303F9F);
      animation: policeFlash 1s infinite alternate;
    }
    
    /* Hiá»‡u á»©ng Ä‘áº·c biá»‡t cho xe cá»©u thÆ°Æ¡ng */
    @keyframes ambulanceFlash {
      0% { 
        background: linear-gradient(135deg, #F44336, #D32F2F);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.5);
      }
      100% { 
        background: linear-gradient(135deg, #FF9800, #F57C00);
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.5);
      }
    }
    
    /* Hiá»‡u á»©ng Ä‘áº·c biá»‡t cho xe cáº£nh sÃ¡t */
    @keyframes policeFlash {
      0% { 
        background: linear-gradient(135deg, #3F51B5, #303F9F);
        box-shadow: 0 4px 12px rgba(63, 81, 181, 0.5);
      }
      100% { 
        background: linear-gradient(135deg, #F44336, #D32F2F);
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.5);
      }
    }
    
    /* Hiá»‡u á»©ng bounce cho táº¥t cáº£ phÆ°Æ¡ng tiá»‡n */
    @keyframes vehicleBounce {
      0% { transform: translateY(0px) scale(1); }
      100% { transform: translateY(-3px) scale(1.05); }
    }
    
    /* Hiá»‡u á»©ng di chuyá»ƒn */
    .vehicle-moving {
      animation: vehicleMove 0.5s ease-in-out;
    }
    
    @keyframes vehicleMove {
      0% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(5deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    
    /* Cháº¿ Ä‘á»™ giao thÃ´ng */
    .traffic-mode .vehicle-marker {
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6);
    }
    
    /* Cháº¿ Ä‘á»™ ban Ä‘Ãªm */
    .night-mode .vehicle-marker {
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
      filter: brightness(1.2);
    }
    
    /* Hiá»‡u á»©ng Ä‘á»• bÃ³ng cho phÆ°Æ¡ng tiá»‡n */
    .vehicle-shadow {
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 6px;
      background: rgba(0,0,0,0.3);
      border-radius: 50%;
      animation: shadowMove 1s infinite alternate;
    }
    
    @keyframes shadowMove {
      0% { transform: translateX(-50%) scaleX(1); }
      100% { transform: translateX(-50%) scaleX(0.8); }
    }
    
    /* Biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn (giá»¯ láº¡i cho tÆ°Æ¡ng thÃ­ch) */
    .person-marker {
      position: absolute;
      width: 30px;
      height: 30px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      font-weight: bold;
      z-index: 1001;
      transition: all 0.3s ease;
      animation: personBounce 1s infinite alternate;
    }
    
    .person-marker::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 8px solid #4CAF50;
    }
    
    .person-marker::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 4px;
      background: rgba(0,0,0,0.2);
      border-radius: 50%;
    }
    
    @keyframes personBounce {
      0% { transform: translateY(0px); }
      100% { transform: translateY(-3px); }
    }
    
    /* NÃºt toggle control panel cho Ä‘iá»‡n thoáº¡i */
    .toggle-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1002;
      background: #007cbf;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .toggle-controls {
        display: flex;
      }
      
      .control-panel {
        left: -320px;
      }
      
      .control-panel.show {
        left: 10px;
      }
    }
    
    /* Animation cho ngÆ°á»i di chuyá»ƒn */
    .person-walking {
      animation: personWalk 2s infinite;
    }
    
    @keyframes personWalk {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      25% { transform: translateY(-2px) rotate(2deg); }
      75% { transform: translateY(-2px) rotate(-2deg); }
    }
    
    /* Hiá»‡u á»©ng Ä‘á»• bÃ³ng cho ngÆ°á»i */
    .person-shadow {
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 6px;
      background: rgba(0,0,0,0.3);
      border-radius: 50%;
      animation: shadowMove 1s infinite alternate;
    }
    
    @keyframes shadowMove {
      0% { transform: translateX(-50%) scaleX(1); }
      100% { transform: translateX(-50%) scaleX(0.8); }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- NÃºt toggle controls cho Ä‘iá»‡n thoáº¡i -->
  <button class="toggle-controls" onclick="toggleControlPanel()" id="toggleBtn">
    â˜°
  </button>
  
  <!-- Panel Ä‘iá»u khiá»ƒn chÃ­nh -->
  <div class="control-panel" id="controlPanel">
    <h3>ğŸ¯ Váº½ Tuyáº¿n Ä‘Æ°á»ng</h3>
    
    <div class="input-group">
      <label>Äiá»ƒm báº¯t Ä‘áº§u:</label>
      <input type="text" id="startPoint" placeholder="Nháº­p tÃªn Ä‘iá»ƒm báº¯t Ä‘áº§u">
    </div>
    
    <div class="input-group">
      <label>Äiá»ƒm káº¿t thÃºc:</label>
      <input type="text" id="endPoint" placeholder="Nháº­p tÃªn Ä‘iá»ƒm káº¿t thÃºc">
    </div>
    
    <div class="input-group">
      <label>TÃªn khá»‘i:</label>
      <input type="text" id="blockName" placeholder="Nháº­p tÃªn khá»‘i (tÃ¹y chá»n)">
    </div>
    
    <div class="input-group">
      <label>Loáº¡i tuyáº¿n Ä‘Æ°á»ng:</label>
      <select id="routeType">
        <option value="driving">ğŸš— ÄÆ°á»ng bá»™</option>
        <option value="walking">ğŸš¶ Äi bá»™</option>
        <option value="cycling">ğŸš´ Xe Ä‘áº¡p</option>
        <option value="custom">âœï¸ TÃ¹y chá»‰nh</option>
      </select>
    </div>
    
    <div class="input-group">
      <label>MÃ u tuyáº¿n Ä‘Æ°á»ng:</label>
      <input type="color" id="routeColor" value="#ff6b6b" onchange="changeTrailColor()" style="width: 100%; height: 40px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer;">
    </div>
    
    <div class="button-group">
      <button id="drawBtn" class="btn btn-primary" onclick="toggleDrawMode()">ğŸ¨ Váº½ Ä‘Æ°á»ng</button>
      <button id="clearBtn" class="btn btn-danger" onclick="clearRoute()">ğŸ—‘ï¸ XÃ³a</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-success" onclick="completeRoute()">âœ… HoÃ n thÃ nh tuyáº¿n</button>
      <button class="btn btn-warning" onclick="editRoute()">âœï¸ Chá»‰nh sá»­a</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-info" onclick="showRouteStats()">ğŸ“Š Thá»‘ng kÃª tuyáº¿n</button>
      <button class="btn btn-primary" onclick="optimizeRoute()">ğŸš€ Tá»‘i Æ°u tuyáº¿n</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-success" onclick="showAllRoutes()">ğŸ—ºï¸ Hiá»ƒn thá»‹ táº¥t cáº£ tuyáº¿n</button>
      <button class="btn btn-warning" onclick="hideAllRoutes()">ğŸ™ˆ áº¨n táº¥t cáº£ tuyáº¿n</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-info" onclick="showRoutesOverview()">ğŸ“Š Tá»•ng quan tuyáº¿n Ä‘Æ°á»ng</button>
      <button class="btn btn-primary" onclick="compareRoutes()">âš–ï¸ So sÃ¡nh tuyáº¿n</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-success" onclick="exportRoute()">ğŸ’¾ Xuáº¥t</button>
      <button class="btn btn-warning" onclick="importRoute()">ğŸ“‚ Nháº­p</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-primary" onclick="saveCurrentRoute()">ğŸ’¾ LÆ°u tuyáº¿n hiá»‡n táº¡i</button>
      <button class="btn btn-info" onclick="exportRoutesToJSON()">ğŸ“„ Xuáº¥t JSON</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-danger" onclick="clearAllRoutes()">ğŸ—‘ï¸ XÃ³a táº¥t cáº£</button>
    </div>
    
    <div class="input-group">
      <label>Chá»n tuyáº¿n Ä‘Æ°á»ng:</label>
      <select id="routeSelector" onchange="switchRoute()">
        <option value="-1">-- Chá»n tuyáº¿n Ä‘Æ°á»ng --</option>
      </select>
    </div>
    
    <div class="button-group">
      <button class="btn btn-primary" onclick="checkNearbyTargets()">ğŸ” TÃ¬m má»¥c tiÃªu gáº§n</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-success" onclick="showAllTargets()">ğŸ¢ Hiá»ƒn thá»‹ táº¥t cáº£ má»¥c tiÃªu</button>
      <button class="btn btn-warning" onclick="hideAllTargets()">ğŸ™ˆ áº¨n má»¥c tiÃªu</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-primary" onclick="toggleStreetView()" id="streetViewBtn">ğŸ›£ï¸ Hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-info" onclick="toggleAutoShowTargets()" id="autoShowBtn">ğŸ” Tá»± Ä‘á»™ng hiá»ƒn thá»‹ má»¥c tiÃªu</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-primary" onclick="showTargetsOverview()">ğŸ“Š Tá»•ng quan má»¥c tiÃªu</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-info" onclick="fitToOverview()">ğŸŒ Xem tá»•ng quan</button>
      <button class="btn btn-warning" onclick="fitToRoute()">ğŸ¯ Xem tuyáº¿n Ä‘Æ°á»ng</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-success" onclick="toggleDetailView()" id="detailViewBtn">ğŸ” Cháº¿ Ä‘á»™ chi tiáº¿t</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-secondary" onclick="resetView()">ğŸ  Reset view</button>
    </div>
    
    <!-- NÃºt má»›i cho biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn -->
    <div class="button-group">
      <button class="btn btn-info" onclick="togglePersonAnimation()" id="personBtn">ğŸ‘¥ Hiá»ƒn thá»‹ ngÆ°á»i di chuyá»ƒn</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-warning" onclick="startPersonAnimation()" id="startPersonBtn">â–¶ï¸ Báº¯t Ä‘áº§u di chuyá»ƒn</button>
      <button class="btn btn-danger" onclick="stopPersonAnimation()" id="stopPersonBtn">â¹ï¸ Dá»«ng di chuyá»ƒn</button>
    </div>
    
    <!-- TÃ¹y chá»n cho ngÆ°á»i váº½ Ä‘Æ°á»ng -->
    <div class="input-group">
      <label>Tá»‘c Ä‘á»™ di chuyá»ƒn:</label>
      <select id="animationSpeed" onchange="changeAnimationSpeed()">
        <option value="slow">ğŸŒ Cháº­m (2s/Ä‘iá»ƒm)</option>
        <option value="normal" selected>ğŸš¶ BÃ¬nh thÆ°á»ng (1s/Ä‘iá»ƒm)</option>
        <option value="fast">ğŸƒ Nhanh (0.5s/Ä‘iá»ƒm)</option>
        <option value="very-fast">âš¡ Ráº¥t nhanh (0.2s/Ä‘iá»ƒm)</option>
      </select>
    </div>
    
    <div class="input-group">
      <label>Äá»™ rá»™ng vá»‡t:</label>
      <input type="range" id="trailWidth" min="2" max="10" value="4" onchange="changeTrailWidth()" style="width: 100%;">
      <span id="trailWidthValue">4px</span>
    </div>
    
    <div class="button-group">
      <button class="btn btn-success" onclick="saveTrailAsRoute()" id="saveTrailBtn">ğŸ’¾ LÆ°u vá»‡t</button>
      <button class="btn btn-danger" onclick="clearTrail()" id="clearTrailBtn">ğŸ—‘ï¸ XÃ³a vá»‡t</button>
    </div>
    
    <div class="button-group">
      <button class="btn btn-warning" onclick="resetPersonPosition()" id="resetBtn">ğŸ”„ Reset vá»‹ trÃ­</button>
      <button class="btn btn-primary" onclick="showTrailInfo()" id="infoBtn">â„¹ï¸ ThÃ´ng tin vá»‡t</button>
    </div>
    
    <div class="route-info" id="routeInfo" style="display: none;">
      <h4>ğŸ“Š ThÃ´ng tin tuyáº¿n Ä‘Æ°á»ng</h4>
      <p id="routeDistance">Khoáº£ng cÃ¡ch: --</p>
      <p id="routeDuration">Thá»i gian: --</p>
      <p id="routePoints">Sá»‘ Ä‘iá»ƒm: --</p>
    </div>
    
    <div class="route-info" id="nearbyInfo" style="display: none;">
      <h4>ğŸ¯ Má»¥c tiÃªu gáº§n tuyáº¿n Ä‘Æ°á»ng</h4>
      <div id="nearbyList"></div>
    </div>
    
    <div class="route-info" id="routesList" style="display: none;">
      <h4>ğŸ—ºï¸ Danh sÃ¡ch tuyáº¿n Ä‘Æ°á»ng</h4>
      <div id="routesListContent"></div>
    </div>
  </div>
  
  <!-- Chá»n kiá»ƒu báº£n Ä‘á»“ -->
  <div class="map-style-selector">
    <select id="mapStyle" onchange="changeMapStyle()">
      <option value="osm">ğŸ—ºï¸ OpenStreetMap</option>
      <option value="satellite">ğŸ›°ï¸ Vá»‡ tinh</option>
      <option value="terrain">ğŸ”ï¸ Äá»‹a hÃ¬nh</option>
      <option value="dark">ğŸŒ™ Tá»‘i</option>
    </select>
  </div>
  
  <!-- ChÃº thÃ­ch -->
  <div class="legend" id="legend">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <h4 style="margin: 0;">ğŸ“‹ ChÃº thÃ­ch</h4>
      <button onclick="toggleLegend()" style="background: none; border: none; cursor: pointer; font-size: 16px; color: #666;">ğŸ‘ï¸</button>
    </div>
    <div id="legendContent">
      <div class="legend-item">
        <div class="legend-color" style="background: #28a745;"></div>
        <span>Äiá»ƒm báº¯t Ä‘áº§u</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #dc3545;"></div>
        <span>Äiá»ƒm káº¿t thÃºc</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #007cbf;"></div>
        <span>Äiá»ƒm trung gian</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #ffc107;"></div>
        <span>Tuyáº¿n Ä‘Æ°á»ng</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #dc3545; width: 36px; height: 36px; border: 4px solid white; position: relative;">
          <div style="position: absolute; top: -4px; right: -4px; background: #dc3545; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">1</div>
        </div>
        <span>Má»¥c tiÃªu (ğŸ¯)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #4CAF50; width: 40px; height: 40px; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; border: 4px solid white; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; font-weight: bold;">ğŸ‘¥</div>
        <span>NgÆ°á»i váº½ Ä‘Æ°á»ng</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #ff6b6b; width: 36px; height: 4px; border-radius: 2px;"></div>
        <span>Vá»‡t di chuyá»ƒn</span>
      </div>
    </div>
  </div>
  
  <!-- Thanh tráº¡ng thÃ¡i -->
  <div class="status-bar" id="statusBar">
    Sáºµn sÃ ng váº½ tuyáº¿n Ä‘Æ°á»ng
  </div>
  
  <script>
    // Khá»Ÿi táº¡o báº£n Ä‘á»“
    const map = L.map('map').setView([21.0365, 105.8341], 15);
    
    // CÃ¡c layer báº£n Ä‘á»“
    const mapLayers = {
      osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }),
      satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri'
      }),
      terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenTopoMap'
      }),
      dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO'
      })
    };
    
    // ThÃªm layer máº·c Ä‘á»‹nh
    mapLayers.osm.addTo(map);
    
    // Biáº¿n quáº£n lÃ½
    let isDrawingMode = false;
    let currentRoute = [];
    let routePolyline = null;
    let startMarker = null;
    let endMarker = null;
    let routeMarkers = [];
    let currentMapStyle = 'osm';
    let targetMarkers = []; // Máº£ng lÆ°u cÃ¡c marker má»¥c tiÃªu
    let nearbyTargetMarkers = []; // Máº£ng lÆ°u cÃ¡c marker má»¥c tiÃªu gáº§n
    let allRoutes = []; // Máº£ng lÆ°u táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng
    let currentRouteIndex = -1; // Index cá»§a tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i
    let autoShowTargets = true; // Cháº¿ Ä‘á»™ tá»± Ä‘á»™ng hiá»ƒn thá»‹ má»¥c tiÃªu
    let detailViewMode = false; // Cháº¿ Ä‘á»™ xem chi tiáº¿t
    let streetViewMode = true; // Cháº¿ Ä‘á»™ hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng
    let allRoutesVisible = false; // Tráº¡ng thÃ¡i hiá»ƒn thá»‹ táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng
    let allRoutePolylines = []; // Máº£ng lÆ°u táº¥t cáº£ polyline cá»§a tuyáº¿n Ä‘Æ°á»ng
    
    // Biáº¿n cho biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn táº¡o vá»‡t
    let personMarker = null; // Biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn
    let personTrail = []; // Máº£ng lÆ°u vá»‡t di chuyá»ƒn
    let trailPolyline = null; // ÄÆ°á»ng vá»‡t
    let isPersonMoving = false; // Tráº¡ng thÃ¡i di chuyá»ƒn
    let personSpeed = 1000; // Tá»‘c Ä‘á»™ di chuyá»ƒn (ms)
    let trailColor = '#ff6b6b'; // MÃ u vá»‡t
    let trailWidth = 4; // Äá»™ rá»™ng vá»‡t
    
    // Biáº¿n cho biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn (giá»¯ láº¡i cho tÆ°Æ¡ng thÃ­ch)
    let personMarkers = []; // Máº£ng lÆ°u cÃ¡c biá»ƒu tÆ°á»£ng ngÆ°á»i
    let personAnimationInterval = null; // Interval cho animation
    let isPersonVisible = false; // Tráº¡ng thÃ¡i hiá»ƒn thá»‹ ngÆ°á»i
    let isPersonAnimating = false; // Tráº¡ng thÃ¡i animation
    let personCurrentIndex = 0; // Index hiá»‡n táº¡i cá»§a ngÆ°á»i trÃªn tuyáº¿n Ä‘Æ°á»ng
    
    // Danh sÃ¡ch cÃ¡c má»¥c tiÃªu vá»›i tá»a Ä‘á»™ Æ°á»›c tÃ­nh
    const targets = [
      { name: "44 Yáº¿t KiÃªu", coords: [21.021515632015056, 105.84222636688743] },
      { name: "112 ÄÆ°á»ng LÃª Duáº©n", coords: [21.026203526657927, 105.8412553380519] },
      { name: "30 Tráº§n BÃ¬nh Trá»ng", coords: [21.017840721169478, 105.84318036688747] },
      { name: "15 P. Tráº§n BÃ¬nh Trá»ng", coords: [21.02162599462683, 105.84518209757319] },
      { name: "3 P. Nguyá»…n ThÆ°á»£ng Hiá»n", coords: [21.01892983496959, 105.84357365154449] },
      { name: "44-46 P. Tráº§n PhÃº", coords: [21.031668790998804, 105.8379764092163] },
      { name: "39 Äáº·ng VÅ© Há»·", coords: [21.075067590622364, 105.8971477332735] },
      { name: "1 Pháº¡m NgÅ© LÃ£o", coords: [21.02456812852695, 105.85929738408043] },
      { name: "25 P. TÃ´ng Äáº£n", coords: [21.026245350554248, 105.85821674760925] },
      { name: "54 Tráº§n HÆ°ng Äáº¡o", coords: [21.02264096812682, 105.85131514759998] },
      { name: "48 P. LÃ½ ThÆ°á»ng Kiá»‡t", coords: [21.024628845190524, 105.84737559387327] },
      { name: "22 HÃ¹ng VÆ°Æ¡ng", coords: [21.03316617476555, 105.8338170938735] },
      { name: "80 P. Tráº§n Quá»‘c HoÃ n", coords: [21.042058921947994, 105.785464882231] },
      { name: "Sá»‘ 1A Quan Hoa", coords: [21.031703434718168, 105.80224451600377] }, 
      { name: "1150 Ä. LÃ¡ng", coords: [21.025956983443567, 105.79860915339471] },
      { name: "280b Ä. Láº¡c Long QuÃ¢n", coords: [21.06371871535174, 105.80934036688865] },
      { name: "47 Ä. Pháº¡m VÄƒn Äá»“ng", coords: [21.048594769824994, 105.78006190921685] },
      { name: "Sá»‘ 30 Ä. Pháº¡m VÄƒn Äá»“ng", coords: [21.044034739150565, 105.78153460921662] },
      { name: "32 P. CÃ¡t Linh", coords: [21.029802493759302, 105.83092955154483] },
      { name: "49 P. LÃ½ ThÃ¡i Tá»•", coords: [21.02733341013021, 105.85657972270901] },
      { name: "28 Tráº§n HÆ°ng Äáº¡o", coords: [21.02132739054037, 105.85537703225303] },
      { name: "504 P. XÃ£ ÄÃ n", coords: [21.017838625651773, 105.83084985339453] },
    ];    
    
    // HÃ m toggle control panel cho Ä‘iá»‡n thoáº¡i
    function toggleControlPanel() {
      const panel = document.getElementById('controlPanel');
      const toggleBtn = document.getElementById('toggleBtn');
      
      if (panel.classList.contains('show')) {
        panel.classList.remove('show');
        toggleBtn.textContent = 'â˜°';
        toggleBtn.style.background = '#007cbf';
      } else {
        panel.classList.add('show');
        toggleBtn.textContent = 'âœ•';
        toggleBtn.style.background = '#dc3545';
      }
    }
    
    // HÃ m táº¡o biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn táº¡o vá»‡t
    function createPersonMarker(coords) {
      const personIcon = L.divIcon({
        className: 'person-marker',
        html: `
          <div style="position: relative;">
            <div style="background: linear-gradient(135deg, #4CAF50, #45a049); width: 40px; height: 40px; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; border: 4px solid white; box-shadow: 0 6px 16px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; position: relative; z-index: 1002;">
              <div style="font-size: 18px;">ğŸ‘¥</div>
              <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 10px solid #4CAF50;"></div>
              <div style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 16px; height: 6px; background: rgba(0,0,0,0.3); border-radius: 50%;"></div>
            </div>
            <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 4px 10px; border-radius: 5px; font-size: 12px; white-space: nowrap; border: 2px solid rgba(255,255,255,0.3); font-weight: bold;">
              ğŸ‘¤ NgÆ°á»i váº½ Ä‘Æ°á»ng
            </div>
          </div>
        `,
        iconSize: [40, 40],
        iconAnchor: [20, 20]
      });
      
      const marker = L.marker(coords, { icon: personIcon, draggable: true }).addTo(map);
      
      // ThÃªm popup cho ngÆ°á»i
      marker.bindPopup(`
        <div style="min-width: 250px; padding: 10px;">
          <h4 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 16px; border-bottom: 2px solid #4CAF50; padding-bottom: 5px;">
            ğŸ‘¤ NgÆ°á»i váº½ Ä‘Æ°á»ng
          </h4>
          <p style="margin: 8px 0; font-size: 13px;"><strong>ğŸ“ Vá»‹ trÃ­:</strong> ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}</p>
          <p style="margin: 8px 0; font-size: 13px;"><strong>ğŸš¦ Tráº¡ng thÃ¡i:</strong> ${isPersonMoving ? 'Äang di chuyá»ƒn' : 'Äá»©ng yÃªn'}</p>
          <p style="margin: 8px 0; font-size: 13px;"><strong>ğŸ“ Äá»™ dÃ i vá»‡t:</strong> ${personTrail.length} Ä‘iá»ƒm</p>
          <p style="margin: 8px 0; font-size: 13px;"><strong>ğŸ¨ MÃ u vá»‡t:</strong> <span style="color: ${trailColor}; font-weight: bold;">${trailColor}</span></p>
          <div style="margin-top: 12px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 12px; color: #2e7d32; border-left: 4px solid #4CAF50;">
            <strong>ğŸ’¡ HÆ°á»›ng dáº«n:</strong><br>
            â€¢ KÃ©o biá»ƒu tÆ°á»£ng Ä‘á»ƒ di chuyá»ƒn<br>
            â€¢ Vá»‡t sáº½ Ä‘Æ°á»£c táº¡o theo Ä‘Æ°á»ng Ä‘i<br>
            â€¢ Sá»­ dá»¥ng nÃºt "â–¶ï¸ Báº¯t Ä‘áº§u di chuyá»ƒn" Ä‘á»ƒ tá»± Ä‘á»™ng
          </div>
        </div>
      `);
      
      // ThÃªm event listener cho drag
      marker.on('drag', function(e) {
        const newCoords = e.target.getLatLng();
        addTrailPoint(newCoords);
        updateTrail();
      });
      
      return marker;
    }
    
    // HÃ m thÃªm Ä‘iá»ƒm vÃ o vá»‡t
    function addTrailPoint(coords) {
      personTrail.push([coords.lat, coords.lng]);
      updateTrail();
    }
    
    // HÃ m cáº­p nháº­t vá»‡t
    function updateTrail() {
      if (trailPolyline) {
        map.removeLayer(trailPolyline);
      }
      
      if (personTrail.length >= 2) {
        trailPolyline = L.polyline(personTrail, {
          color: trailColor,
          weight: trailWidth,
          opacity: 0.8,
          smoothFactor: 1,
          lineCap: 'round',
          lineJoin: 'round'
        }).addTo(map);
        
        // ThÃªm popup cho vá»‡t
        trailPolyline.bindPopup(`
          <div style="min-width: 250px; padding: 10px;">
            <h4 style="margin: 0 0 10px 0; color: ${trailColor}; border-bottom: 2px solid ${trailColor}; padding-bottom: 5px;">
              ğŸ›¤ï¸ Vá»‡t di chuyá»ƒn
            </h4>
            <p style="margin: 8px 0; font-size: 13px;"><strong>ğŸ“ Äá»™ dÃ i:</strong> ${personTrail.length} Ä‘iá»ƒm</p>
            <p style="margin: 8px 0; font-size: 13px;"><strong>ğŸ¨ MÃ u sáº¯c:</strong> <span style="color: ${trailColor}; font-weight: bold;">${trailColor}</span></p>
            <p style="margin: 8px 0; font-size: 13px;"><strong>ğŸ“ Äá»™ rá»™ng:</strong> ${trailWidth}px</p>
            <div style="margin-top: 12px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666; border-left: 4px solid ${trailColor};">
              <strong>ğŸ’¡ ThÃ´ng tin:</strong><br>
              â€¢ Vá»‡t Ä‘Æ°á»£c táº¡o bá»Ÿi ngÆ°á»i di chuyá»ƒn<br>
              â€¢ CÃ³ thá»ƒ sá»­ dá»¥ng lÃ m tuyáº¿n Ä‘Æ°á»ng<br>
              â€¢ Click "ğŸ’¾ LÆ°u vá»‡t" Ä‘á»ƒ lÆ°u tuyáº¿n Ä‘Æ°á»ng
            </div>
          </div>
        `);
      }
    }
    
    // HÃ m táº¡o biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn (giá»¯ láº¡i cho tÆ°Æ¡ng thÃ­ch)
    function createPersonMarker(coords, index = 0) {
      const personIcon = L.divIcon({
        className: 'person-marker',
        html: `
          <div style="position: relative;">
            <div style="background: linear-gradient(135deg, #4CAF50, #45a049); width: 30px; height: 30px; border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: bold; position: relative;">
              <div style="font-size: 14px;">ğŸ‘¥</div>
              <div style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 8px solid #4CAF50;"></div>
              <div style="position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 12px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 50%;"></div>
            </div>
            <div style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; white-space: nowrap;">NhÃ³m ${index + 1}</div>
          </div>
        `,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
      
      const personMarker = L.marker(coords, { icon: personIcon }).addTo(map);
      
      // ThÃªm popup cho ngÆ°á»i
      personMarker.bindPopup(`
        <div style="min-width: 200px; padding: 8px;">
          <h4 style="margin: 0 0 8px 0; color: #4CAF50; font-size: 14px; border-bottom: 2px solid #4CAF50; padding-bottom: 5px;">ğŸ‘¥ NhÃ³m ${index + 1}</h4>
          <p style="margin: 6px 0; font-size: 12px;"><strong>Vá»‹ trÃ­:</strong> ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}</p>
          <p style="margin: 6px 0; font-size: 12px;"><strong>Tráº¡ng thÃ¡i:</strong> ${isPersonAnimating ? 'Äang di chuyá»ƒn' : 'Äá»©ng yÃªn'}</p>
          <p style="margin: 6px 0; font-size: 12px;"><strong>Tiáº¿n Ä‘á»™:</strong> ${personCurrentIndex + 1}/${currentRoute.length}</p>
          <div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px; font-size: 11px; color: #2e7d32; border-left: 4px solid #4CAF50;">
            <strong>ğŸ’¡ ThÃ´ng tin:</strong><br>
            â€¢ NhÃ³m ${index + 1} ngÆ°á»i<br>
            â€¢ Äang di chuyá»ƒn theo tuyáº¿n Ä‘Æ°á»ng<br>
            â€¢ Sá»­ dá»¥ng nÃºt "â–¶ï¸ Báº¯t Ä‘áº§u di chuyá»ƒn" Ä‘á»ƒ báº¯t Ä‘áº§u
          </div>
        </div>
      `);
      
      return personMarker;
    }
    
    // HÃ m hiá»ƒn thá»‹/áº©n biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn táº¡o vá»‡t
    function togglePersonAnimation() {
      const btn = document.getElementById('personBtn');
      
      if (!personMarker) {
        // Táº¡o biá»ƒu tÆ°á»£ng ngÆ°á»i di chuyá»ƒn
        const center = map.getCenter();
        personMarker = createPersonMarker(center);
        personTrail = [];
        
        btn.textContent = 'ğŸ‘¤ áº¨n ngÆ°á»i váº½ Ä‘Æ°á»ng';
        btn.classList.remove('btn-info');
        btn.classList.add('btn-warning');
        updateStatus('ğŸ‘¤ ÄÃ£ hiá»ƒn thá»‹ ngÆ°á»i váº½ Ä‘Æ°á»ng - KÃ©o Ä‘á»ƒ táº¡o vá»‡t');
      } else {
        // áº¨n biá»ƒu tÆ°á»£ng ngÆ°á»i vÃ  vá»‡t
        if (personMarker) {
          map.removeLayer(personMarker);
          personMarker = null;
        }
        
        if (trailPolyline) {
          map.removeLayer(trailPolyline);
          trailPolyline = null;
        }
        
        personTrail = [];
        
        btn.textContent = 'ğŸ‘¤ Hiá»ƒn thá»‹ ngÆ°á»i váº½ Ä‘Æ°á»ng';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-info');
        updateStatus('ÄÃ£ áº©n ngÆ°á»i váº½ Ä‘Æ°á»ng');
      }
    }
    
    // HÃ m báº¯t Ä‘áº§u animation di chuyá»ƒn tá»± Ä‘á»™ng
    function startPersonAnimation() {
      if (!personMarker) {
        alert('Vui lÃ²ng hiá»ƒn thá»‹ ngÆ°á»i váº½ Ä‘Æ°á»ng trÆ°á»›c!');
        return;
      }
      
      if (isPersonMoving) {
        alert('Animation Ä‘ang cháº¡y!');
        return;
      }
      
      isPersonMoving = true;
      
      const startBtn = document.getElementById('startPersonBtn');
      const stopBtn = document.getElementById('stopPersonBtn');
      
      startBtn.disabled = true;
      startBtn.textContent = 'â–¶ï¸ Äang di chuyá»ƒn...';
      stopBtn.disabled = false;
      
      // Báº¯t Ä‘áº§u di chuyá»ƒn tá»± Ä‘á»™ng
      const moveInterval = setInterval(() => {
        if (!isPersonMoving) {
          clearInterval(moveInterval);
          return;
        }
        
        // Di chuyá»ƒn ngáº«u nhiÃªn
        const currentPos = personMarker.getLatLng();
        const latOffset = (Math.random() - 0.5) * 0.001; // Khoáº£ng 100m
        const lngOffset = (Math.random() - 0.5) * 0.001;
        
        const newPos = L.latLng(currentPos.lat + latOffset, currentPos.lng + lngOffset);
        personMarker.setLatLng(newPos);
        
        // ThÃªm Ä‘iá»ƒm vÃ o vá»‡t
        addTrailPoint(newPos);
        
        updateStatus(`ğŸ‘¤ Äang di chuyá»ƒn tá»± Ä‘á»™ng - Vá»‡t: ${personTrail.length} Ä‘iá»ƒm`);
      }, personSpeed);
      
      updateStatus('â–¶ï¸ ÄÃ£ báº¯t Ä‘áº§u di chuyá»ƒn tá»± Ä‘á»™ng');
    }
    
    // HÃ m dá»«ng animation di chuyá»ƒn
    function stopPersonAnimation() {
      if (!isPersonMoving) {
        return;
      }
      
      isPersonMoving = false;
      
      const startBtn = document.getElementById('startPersonBtn');
      const stopBtn = document.getElementById('stopPersonBtn');
      
      startBtn.disabled = false;
      startBtn.textContent = 'â–¶ï¸ Báº¯t Ä‘áº§u di chuyá»ƒn';
      stopBtn.disabled = true;
      
      updateStatus('â¹ï¸ ÄÃ£ dá»«ng di chuyá»ƒn tá»± Ä‘á»™ng');
    }
    
    // HÃ m thay Ä‘á»•i mÃ u vá»‡t
    function changeTrailColor() {
      const colorInput = document.getElementById('routeColor');
      trailColor = colorInput.value;
      updateTrail();
      updateStatus(`ÄÃ£ thay Ä‘á»•i mÃ u vá»‡t: ${trailColor}`);
    }
    
    // HÃ m thay Ä‘á»•i Ä‘á»™ rá»™ng vá»‡t
    function changeTrailWidth() {
      const widthInput = document.getElementById('trailWidth');
      const widthValue = document.getElementById('trailWidthValue');
      trailWidth = parseInt(widthInput.value);
      widthValue.textContent = `${trailWidth}px`;
      updateTrail();
      updateStatus(`ÄÃ£ thay Ä‘á»•i Ä‘á»™ rá»™ng vá»‡t: ${trailWidth}px`);
    }
    
    // HÃ m thay Ä‘á»•i tá»‘c Ä‘á»™ di chuyá»ƒn
    function changeAnimationSpeed() {
      const speed = document.getElementById('animationSpeed').value;
      const speeds = {
        'slow': 2000,
        'normal': 1000,
        'fast': 500,
        'very-fast': 200
      };
      personSpeed = speeds[speed];
      updateStatus(`ÄÃ£ thay Ä‘á»•i tá»‘c Ä‘á»™: ${speed}`);
    }
    
    // HÃ m lÆ°u vá»‡t thÃ nh tuyáº¿n Ä‘Æ°á»ng
    function saveTrailAsRoute() {
      if (personTrail.length < 2) {
        alert('Vá»‡t quÃ¡ ngáº¯n Ä‘á»ƒ lÆ°u thÃ nh tuyáº¿n Ä‘Æ°á»ng!');
        return;
      }
      
      // LÆ°u vá»‡t vÃ o tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i
      currentRoute = [...personTrail];
      
      // Váº½ tuyáº¿n Ä‘Æ°á»ng
      if (routePolyline) {
        map.removeLayer(routePolyline);
      }
      
      routePolyline = L.polyline(currentRoute, {
        color: trailColor,
        weight: trailWidth,
        opacity: 0.8,
        smoothFactor: 1
      }).addTo(map);
      
      // Cáº­p nháº­t thÃ´ng tin
      updateRouteInfo();
      
      updateStatus(`âœ… ÄÃ£ lÆ°u vá»‡t thÃ nh tuyáº¿n Ä‘Æ°á»ng: ${personTrail.length} Ä‘iá»ƒm`);
    }
    
    // HÃ m xÃ³a vá»‡t
    function clearTrail() {
      if (trailPolyline) {
        map.removeLayer(trailPolyline);
        trailPolyline = null;
      }
      personTrail = [];
      updateStatus('ğŸ—‘ï¸ ÄÃ£ xÃ³a vá»‡t');
    }
    
    // HÃ m reset vá»‹ trÃ­ ngÆ°á»i
    function resetPersonPosition() {
      if (!personMarker) {
        alert('Vui lÃ²ng hiá»ƒn thá»‹ ngÆ°á»i váº½ Ä‘Æ°á»ng trÆ°á»›c!');
        return;
      }
      
      const center = map.getCenter();
      personMarker.setLatLng(center);
      updateStatus('ğŸ”„ ÄÃ£ reset vá»‹ trÃ­ ngÆ°á»i vá» trung tÃ¢m');
    }
    
    // HÃ m hiá»ƒn thá»‹ thÃ´ng tin vá»‡t
    function showTrailInfo() {
      if (!personMarker) {
        alert('Vui lÃ²ng hiá»ƒn thá»‹ ngÆ°á»i váº½ Ä‘Æ°á»ng trÆ°á»›c!');
        return;
      }
      
      const infoContent = `
        <div style="min-width: 300px; padding: 15px;">
          <h4 style="margin: 0 0 15px 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 8px;">
            ğŸ‘¤ ThÃ´ng tin ngÆ°á»i váº½ Ä‘Æ°á»ng
          </h4>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ‘¤ ThÃ´ng tin ngÆ°á»i</h5>
            <p style="margin: 5px 0;"><strong>Tráº¡ng thÃ¡i:</strong> ${isPersonMoving ? 'Äang di chuyá»ƒn' : 'Äá»©ng yÃªn'}</p>
            <p style="margin: 5px 0;"><strong>Tá»‘c Ä‘á»™:</strong> ${personSpeed}ms/Ä‘iá»ƒm</p>
            <p style="margin: 5px 0;"><strong>Vá»‹ trÃ­:</strong> ${personMarker.getLatLng().lat.toFixed(6)}, ${personMarker.getLatLng().lng.toFixed(6)}</p>
          </div>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #1565c0;">ğŸ›¤ï¸ ThÃ´ng tin vá»‡t</h5>
            <p style="margin: 5px 0;"><strong>Äá»™ dÃ i:</strong> ${personTrail.length} Ä‘iá»ƒm</p>
            <p style="margin: 5px 0;"><strong>MÃ u sáº¯c:</strong> <span style="color: ${trailColor}; font-weight: bold;">${trailColor}</span></p>
            <p style="margin: 5px 0;"><strong>Äá»™ rá»™ng:</strong> ${trailWidth}px</p>
            <p style="margin: 5px 0;"><strong>Khoáº£ng cÃ¡ch:</strong> ${personTrail.length > 1 ? calculateDistance(personTrail).toFixed(2) : '0'} km</p>
          </div>
          
          <div style="padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
            <strong>ğŸ’¡ HÆ°á»›ng dáº«n:</strong><br>
            â€¢ KÃ©o biá»ƒu tÆ°á»£ng Ä‘á»ƒ di chuyá»ƒn thá»§ cÃ´ng<br>
            â€¢ Sá»­ dá»¥ng "â–¶ï¸ Báº¯t Ä‘áº§u di chuyá»ƒn" Ä‘á»ƒ tá»± Ä‘á»™ng<br>
            â€¢ Click "ğŸ’¾ LÆ°u vá»‡t" Ä‘á»ƒ lÆ°u thÃ nh tuyáº¿n Ä‘Æ°á»ng<br>
            â€¢ Click "ğŸ—‘ï¸ XÃ³a vá»‡t" Ä‘á»ƒ xÃ³a vá»‡t hiá»‡n táº¡i
          </div>
        </div>
      `;
      
      L.popup({
        maxWidth: 400,
        maxHeight: 600
      })
      .setLatLng(personMarker.getLatLng())
      .setContent(infoContent)
      .openOn(map);
      
      updateStatus('â„¹ï¸ ÄÃ£ hiá»ƒn thá»‹ thÃ´ng tin vá»‡t');
    }
    
    // HÃ m thay Ä‘á»•i tá»‘c Ä‘á»™ animation
    function changeAnimationSpeed() {
      const speed = document.getElementById('animationSpeed').value;
      const speeds = {
        'slow': 2000,
        'normal': 1000,
        'fast': 500,
        'very-fast': 200
      };
      vehicleSpeed = speeds[speed];
      
      if (isVehicleAnimating) {
        // Restart animation vá»›i tá»‘c Ä‘á»™ má»›i
        stopVehicleAnimation();
        startPersonAnimation();
      }
      
      updateStatus(`ÄÃ£ thay Ä‘á»•i tá»‘c Ä‘á»™: ${speed}`);
    }
    
    // HÃ m thay Ä‘á»•i sá»‘ lÆ°á»£ng phÆ°Æ¡ng tiá»‡n
    function changeVehicleCount() {
      vehicleCount = parseInt(document.getElementById('vehicleCount').value);
      if (isVehicleVisible) {
        // Táº¡o láº¡i cÃ¡c marker vá»›i sá»‘ lÆ°á»£ng má»›i
        vehicleMarkers.forEach(marker => map.removeLayer(marker));
        vehicleMarkers = [];
        
        const numVehicles = Math.min(vehicleCount, currentRoute.length);
        for (let i = 0; i < numVehicles; i++) {
          const startIndex = Math.floor(i * currentRoute.length / numVehicles);
          const coords = currentRoute[startIndex];
          const vehicleMarker = createVehicleMarker(coords, i);
          vehicleMarkers.push(vehicleMarker);
        }
        
        updateStatus(`ÄÃ£ thay Ä‘á»•i sá»‘ lÆ°á»£ng: ${numVehicles} phÆ°Æ¡ng tiá»‡n`);
      }
    }
    
    // HÃ m Ä‘áº£o chiá»u animation
    function reverseAnimation() {
      vehicleDirection = -vehicleDirection;
      const reverseBtn = document.getElementById('reverseBtn');
      
      if (vehicleDirection > 0) {
        reverseBtn.textContent = 'ğŸ”„ Äáº£o chiá»u';
        updateStatus('ÄÃ£ Ä‘áº£o chiá»u: Tiáº¿n');
      } else {
        reverseBtn.textContent = 'ğŸ”„ Äáº£o chiá»u (LÃ¹i)';
        updateStatus('ÄÃ£ Ä‘áº£o chiá»u: LÃ¹i');
      }
    }
    
    // HÃ m táº¡m dá»«ng animation
    function pauseAnimation() {
      if (!isVehicleAnimating) {
        alert('KhÃ´ng cÃ³ animation Ä‘ang cháº¡y!');
        return;
      }
      
      isAnimationPaused = !isAnimationPaused;
      const pauseBtn = document.getElementById('pauseBtn');
      
      if (isAnimationPaused) {
        pauseBtn.textContent = 'â–¶ï¸ Tiáº¿p tá»¥c';
        updateStatus('â¸ï¸ ÄÃ£ táº¡m dá»«ng animation');
      } else {
        pauseBtn.textContent = 'â¸ï¸ Táº¡m dá»«ng';
        updateStatus('â–¶ï¸ ÄÃ£ tiáº¿p tá»¥c animation');
      }
    }
    
    // HÃ m reset vá»‹ trÃ­ animation
    function resetAnimation() {
      if (!isVehicleVisible) {
        alert('Vui lÃ²ng hiá»ƒn thá»‹ phÆ°Æ¡ng tiá»‡n trÆ°á»›c!');
        return;
      }
      
      vehicleCurrentIndex = 0;
      vehicleDirection = 1;
      
      // Äáº·t láº¡i vá»‹ trÃ­ cÃ¡c phÆ°Æ¡ng tiá»‡n
      vehicleMarkers.forEach((marker, index) => {
        const startIndex = Math.floor(index * currentRoute.length / vehicleMarkers.length);
        const coords = currentRoute[startIndex];
        marker.setLatLng(coords);
      });
      
      updateStatus('ğŸ”„ ÄÃ£ reset vá»‹ trÃ­ phÆ°Æ¡ng tiá»‡n vá» Ä‘áº§u tuyáº¿n');
    }
    
    // HÃ m hiá»ƒn thá»‹ thÃ´ng tin animation
    function showAnimationInfo() {
      if (!isVehicleVisible) {
        alert('Vui lÃ²ng hiá»ƒn thá»‹ phÆ°Æ¡ng tiá»‡n trÆ°á»›c!');
        return;
      }
      
      const infoContent = `
        <div style="min-width: 300px; padding: 15px;">
          <h4 style="margin: 0 0 15px 0; color: #2196F3; border-bottom: 2px solid #2196F3; padding-bottom: 8px;">
            â„¹ï¸ ThÃ´ng tin Animation
          </h4>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #1565c0;">ğŸš— ThÃ´ng tin phÆ°Æ¡ng tiá»‡n</h5>
            <p style="margin: 5px 0;"><strong>Loáº¡i:</strong> ${getVehicleTypeName()}</p>
            <p style="margin: 5px 0;"><strong>Sá»‘ lÆ°á»£ng:</strong> ${vehicleMarkers.length}</p>
            <p style="margin: 5px 0;"><strong>Tráº¡ng thÃ¡i:</strong> ${isVehicleAnimating ? 'Äang di chuyá»ƒn' : 'Äá»©ng yÃªn'}</p>
            <p style="margin: 5px 0;"><strong>Táº¡m dá»«ng:</strong> ${isAnimationPaused ? 'CÃ³' : 'KhÃ´ng'}</p>
          </div>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #f3e5f5; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #7b1fa2;">âš¡ ThÃ´ng tin di chuyá»ƒn</h5>
            <p style="margin: 5px 0;"><strong>Tá»‘c Ä‘á»™:</strong> ${vehicleSpeed}ms/Ä‘iá»ƒm</p>
            <p style="margin: 5px 0;"><strong>HÆ°á»›ng:</strong> ${vehicleDirection > 0 ? 'Tiáº¿n' : 'LÃ¹i'}</p>
            <p style="margin: 5px 0;"><strong>Vá»‹ trÃ­ hiá»‡n táº¡i:</strong> ${vehicleCurrentIndex + 1}/${currentRoute.length}</p>
            <p style="margin: 5px 0;"><strong>Tiáº¿n Ä‘á»™:</strong> ${((vehicleCurrentIndex + 1) / currentRoute.length * 100).toFixed(1)}%</p>
          </div>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ›ï¸ Äiá»u khiá»ƒn</h5>
            <p style="margin: 5px 0;"><strong>Cháº¿ Ä‘á»™ giao thÃ´ng:</strong> ${trafficMode ? 'Báº­t' : 'Táº¯t'}</p>
            <p style="margin: 5px 0;"><strong>Cháº¿ Ä‘á»™ ban Ä‘Ãªm:</strong> ${nightMode ? 'Báº­t' : 'Táº¯t'}</p>
            <p style="margin: 5px 0;"><strong>Tuyáº¿n Ä‘Æ°á»ng:</strong> ${currentRoute.length} Ä‘iá»ƒm</p>
            <p style="margin: 5px 0;"><strong>Khoáº£ng cÃ¡ch:</strong> ${calculateDistance(currentRoute).toFixed(2)} km</p>
          </div>
          
          <div style="padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
            <strong>ğŸ’¡ Gá»£i Ã½:</strong><br>
            â€¢ Sá»­ dá»¥ng cÃ¡c nÃºt Ä‘iá»u khiá»ƒn Ä‘á»ƒ thay Ä‘á»•i animation<br>
            â€¢ Thay Ä‘á»•i loáº¡i phÆ°Æ¡ng tiá»‡n Ä‘á»ƒ cÃ³ hiá»‡u á»©ng khÃ¡c nhau<br>
            â€¢ Äiá»u chá»‰nh tá»‘c Ä‘á»™ phÃ¹ há»£p vá»›i nhu cáº§u
          </div>
        </div>
      `;
      
      L.popup({
        maxWidth: 400,
        maxHeight: 600
      })
      .setLatLng(map.getCenter())
      .setContent(infoContent)
      .openOn(map);
      
      updateStatus('â„¹ï¸ ÄÃ£ hiá»ƒn thá»‹ thÃ´ng tin animation');
    }
    
    // HÃ m báº­t/táº¯t cháº¿ Ä‘á»™ giao thÃ´ng
    function toggleTrafficMode() {
      trafficMode = !trafficMode;
      const trafficBtn = document.getElementById('trafficBtn');
      
      if (trafficMode) {
        trafficBtn.textContent = 'ğŸš¦ Cháº¿ Ä‘á»™ giao thÃ´ng (Báº¬T)';
        trafficBtn.classList.remove('btn-success');
        trafficBtn.classList.add('btn-warning');
        document.body.classList.add('traffic-mode');
        updateStatus('ğŸš¦ ÄÃ£ báº­t cháº¿ Ä‘á»™ giao thÃ´ng');
      } else {
        trafficBtn.textContent = 'ğŸš¦ Cháº¿ Ä‘á»™ giao thÃ´ng';
        trafficBtn.classList.remove('btn-warning');
        trafficBtn.classList.add('btn-success');
        document.body.classList.remove('traffic-mode');
        updateStatus('ğŸš¦ ÄÃ£ táº¯t cháº¿ Ä‘á»™ giao thÃ´ng');
      }
    }
    
    // HÃ m báº­t/táº¯t cháº¿ Ä‘á»™ ban Ä‘Ãªm
    function toggleNightMode() {
      nightMode = !nightMode;
      const nightBtn = document.getElementById('nightBtn');
      
      if (nightMode) {
        nightBtn.textContent = 'ğŸŒ™ Cháº¿ Ä‘á»™ ban Ä‘Ãªm (Báº¬T)';
        nightBtn.classList.remove('btn-info');
        nightBtn.classList.add('btn-warning');
        document.body.classList.add('night-mode');
        updateStatus('ğŸŒ™ ÄÃ£ báº­t cháº¿ Ä‘á»™ ban Ä‘Ãªm');
      } else {
        nightBtn.textContent = 'ğŸŒ™ Cháº¿ Ä‘á»™ ban Ä‘Ãªm';
        nightBtn.classList.remove('btn-warning');
        nightBtn.classList.add('btn-info');
        document.body.classList.remove('night-mode');
        updateStatus('ğŸŒ™ ÄÃ£ táº¯t cháº¿ Ä‘á»™ ban Ä‘Ãªm');
      }
    }
    
    // HÃ m Ä‘á»•i kiá»ƒu báº£n Ä‘á»“
    function changeMapStyle() {
      const style = document.getElementById('mapStyle').value;
      if (currentMapStyle !== style) {
        map.removeLayer(mapLayers[currentMapStyle]);
        mapLayers[style].addTo(map);
        currentMapStyle = style;
      }
    }
    
    // HÃ m tÃ­nh khoáº£ng cÃ¡ch
    function calculateDistance(coords) {
      let totalDistance = 0;
      for (let i = 1; i < coords.length; i++) {
        const lat1 = coords[i-1][0];
        const lon1 = coords[i-1][1];
        const lat2 = coords[i][0];
        const lon2 = coords[i][1];
        
        const R = 6371; // BÃ¡n kÃ­nh TrÃ¡i Äáº¥t (km)
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        totalDistance += R * c;
      }
      return totalDistance;
    }
    
    // HÃ m cáº­p nháº­t thÃ´ng tin tuyáº¿n Ä‘Æ°á»ng
    function updateRouteInfo() {
      if (currentRoute.length >= 2) {
        const distance = calculateDistance(currentRoute);
        const duration = Math.round(distance * 3); // Æ¯á»›c tÃ­nh thá»i gian (phÃºt)
        
        document.getElementById('routeDistance').textContent = `Khoáº£ng cÃ¡ch: ${distance.toFixed(2)} km`;
        document.getElementById('routeDuration').textContent = `Thá»i gian: ~${duration} phÃºt`;
        document.getElementById('routePoints').textContent = `Sá»‘ Ä‘iá»ƒm: ${currentRoute.length}`;
        document.getElementById('routeInfo').style.display = 'block';
      } else {
        document.getElementById('routeInfo').style.display = 'none';
      }
    }
    
    // HÃ m cáº­p nháº­t tráº¡ng thÃ¡i
    function updateStatus(message) {
      document.getElementById('statusBar').textContent = message;
    }
    
    // HÃ m báº­t/táº¯t cháº¿ Ä‘á»™ váº½
    function toggleDrawMode() {
      isDrawingMode = !isDrawingMode;
      const drawBtn = document.getElementById('drawBtn');
      
      if (isDrawingMode) {
        drawBtn.textContent = 'â¹ï¸ Dá»«ng váº½';
        drawBtn.classList.add('active');
        map.getContainer().style.cursor = 'crosshair';
        
        // KhÃ´ng tá»± Ä‘á»™ng hiá»ƒn thá»‹ má»¥c tiÃªu khi báº¯t Ä‘áº§u váº½
        // Má»¥c tiÃªu chá»‰ hiá»ƒn thá»‹ khi tÃ¬m kiáº¿m
        
        // Thu nhá» báº£n Ä‘á»“ Ä‘á»ƒ xem tá»•ng quan nhÆ°ng váº«n nhÃ¬n rÃµ Ä‘Æ°á»ng
        const drawZoom = detailViewMode ? 16 : 14; // Zoom cao hÆ¡n náº¿u á»Ÿ cháº¿ Ä‘á»™ chi tiáº¿t
        map.setZoom(drawZoom);
        updateStatus(`Äang váº½ tuyáº¿n Ä‘Æ°á»ng - Click Ä‘á»ƒ thÃªm Ä‘iá»ƒm (Zoom: ${drawZoom}) - Sá»­ dá»¥ng "ğŸ” TÃ¬m má»¥c tiÃªu gáº§n" Ä‘á»ƒ hiá»ƒn thá»‹ má»¥c tiÃªu`);
      } else {
        drawBtn.textContent = 'ğŸ¨ Váº½ Ä‘Æ°á»ng';
        drawBtn.classList.remove('active');
        map.getContainer().style.cursor = '';
        updateStatus('Sáºµn sÃ ng váº½ tuyáº¿n Ä‘Æ°á»ng');
      }
    }
    
    // HÃ m xÃ³a Ä‘Æ°á»ng (cáº­p nháº­t)
    function clearRoute() {
      clearCurrentRoute();
      // XÃ³a vá»‡t náº¿u Ä‘ang hiá»ƒn thá»‹
      if (personMarker) {
        clearTrail();
      }
      updateStatus('ÄÃ£ xÃ³a tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i');
    }
    
    // HÃ m xuáº¥t tuyáº¿n Ä‘Æ°á»ng
    function exportRoute() {
      if (allRoutes.length === 0 && currentRoute.length === 0) {
        alert('ChÆ°a cÃ³ tuyáº¿n Ä‘Æ°á»ng Ä‘á»ƒ xuáº¥t!');
        return;
      }
      
      let routeData;
      
      if (allRoutes.length > 0) {
        // Xuáº¥t táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng
        routeData = {
          type: 'multiple_routes',
          routes: allRoutes,
          totalRoutes: allRoutes.length,
          totalDistance: allRoutes.reduce((sum, route) => sum + route.distance, 0),
          timestamp: new Date().toISOString()
        };
      } else {
        // Xuáº¥t tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i
        routeData = {
          type: 'single_route',
          startPoint: document.getElementById('startPoint').value || 'Äiá»ƒm báº¯t Ä‘áº§u',
          endPoint: document.getElementById('endPoint').value || 'Äiá»ƒm káº¿t thÃºc',
          blockName: document.getElementById('blockName').value || 'KhÃ´ng cÃ³ tÃªn khá»‘i',
          routeType: document.getElementById('routeType').value,
          coordinates: currentRoute,
          distance: calculateDistance(currentRoute),
          timestamp: new Date().toISOString()
        };
      }
      
      const dataStr = JSON.stringify(routeData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `tuyen-duong-${new Date().getTime()}.json`;
      link.click();
      
      updateStatus(`ÄÃ£ xuáº¥t ${routeData.type === 'multiple_routes' ? allRoutes.length : 1} tuyáº¿n Ä‘Æ°á»ng`);
    }
    
    // HÃ m nháº­p tuyáº¿n Ä‘Æ°á»ng
    function importRoute() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const routeData = JSON.parse(e.target.result);
              
              // Xá»­ lÃ½ format JSON má»›i vá»›i exportInfo vÃ  routes
              if (routeData.exportInfo && routeData.routes) {
                // Nháº­p nhiá»u tuyáº¿n Ä‘Æ°á»ng tá»« format export
                allRoutes = routeData.routes || [];
                updateRouteSelector();
                updateRoutesList();
                clearCurrentRoute();
                
                // Hiá»ƒn thá»‹ thÃ´ng tin chi tiáº¿t vá» file Ä‘Ã£ nháº­p
                const totalDistance = allRoutes.reduce((sum, route) => sum + route.distance, 0);
                updateStatus(`ÄÃ£ nháº­p ${allRoutes.length} tuyáº¿n Ä‘Æ°á»ng tá»« file export (Tá»•ng: ${totalDistance.toFixed(2)} km)`);
                
                // Hiá»ƒn thá»‹ tuyáº¿n Ä‘Æ°á»ng Ä‘áº§u tiÃªn náº¿u cÃ³
                if (allRoutes.length > 0) {
                  document.getElementById('routeSelector').value = 0;
                  switchRoute();
                }
              } else if (routeData.type === 'multiple_routes') {
                // Nháº­p nhiá»u tuyáº¿n Ä‘Æ°á»ng tá»« format cÅ©
                allRoutes = routeData.routes || [];
                updateRouteSelector();
                updateRoutesList();
                clearCurrentRoute();
                updateStatus(`ÄÃ£ nháº­p ${allRoutes.length} tuyáº¿n Ä‘Æ°á»ng`);
              } else {
                // Nháº­p tuyáº¿n Ä‘Æ°á»ng Ä‘Æ¡n
                clearAllRoutes();
                
                const newRoute = {
                  id: Date.now(),
                  name: `${routeData.startPoint} â†’ ${routeData.endPoint}`,
                  startPoint: routeData.startPoint || '',
                  endPoint: routeData.endPoint || '',
                  blockName: routeData.blockName || '',
                  routeType: routeData.routeType || 'custom',
                  coordinates: routeData.coordinates || [],
                  distance: routeData.distance || 0,
                  timestamp: routeData.timestamp || new Date().toISOString(),
                  color: routeData.color || getRandomRouteColor()
                };
                
                allRoutes.push(newRoute);
                updateRouteSelector();
                updateRoutesList();
                
                // Hiá»ƒn thá»‹ tuyáº¿n Ä‘Æ°á»ng Ä‘áº§u tiÃªn
                document.getElementById('routeSelector').value = 0;
                switchRoute();
                
                updateStatus('ÄÃ£ nháº­p tuyáº¿n Ä‘Æ°á»ng');
              }
            } catch (error) {
              alert('Lá»—i khi Ä‘á»c file: ' + error.message);
              console.error('Chi tiáº¿t lá»—i:', error);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }
    
    // HÃ m váº½ tuyáº¿n Ä‘Æ°á»ng Ä‘Ã£ nháº­p
    function drawImportedRoute() {
      if (currentRoute.length >= 2) {
        // Váº½ Ä‘Æ°á»ng
        routePolyline = L.polyline(currentRoute, {
          color: '#ffc107',
          weight: 5,
          opacity: 0.8,
          smoothFactor: 1
        }).addTo(map);
        
        // Váº½ marker
        currentRoute.forEach((coord, index) => {
          const marker = L.circleMarker(coord, {
            radius: index === 0 ? 8 : (index === currentRoute.length - 1 ? 8 : 4),
            fillColor: index === 0 ? '#28a745' : (index === currentRoute.length - 1 ? '#dc3545' : '#007cbf'),
            color: index === 0 ? '#1e7e34' : (index === currentRoute.length - 1 ? '#c82333' : '#005a8b'),
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);
          
          routeMarkers.push(marker);
        });
        
        updateRouteInfo();
      }
    }
    
    // HÃ m tÃ¬m má»¥c tiÃªu gáº§n tuyáº¿n Ä‘Æ°á»ng
    function checkNearbyTargets() {
      if (currentRoute.length < 2) {
        alert('Vui lÃ²ng váº½ tuyáº¿n Ä‘Æ°á»ng trÆ°á»›c khi tÃ¬m má»¥c tiÃªu gáº§n!');
        return;
      }

      // XÃ³a cÃ¡c marker má»¥c tiÃªu gáº§n cÅ©
      hideNearbyTargets();

      const nearbyList = document.getElementById('nearbyList');
      nearbyList.innerHTML = ''; // XÃ³a danh sÃ¡ch cÅ©

      // TÃ­nh khoáº£ng cÃ¡ch tá»« má»—i má»¥c tiÃªu Ä‘áº¿n tuyáº¿n Ä‘Æ°á»ng
      const targetDistances = targets.map(target => {
        let minDistance = Infinity;
        
        // TÃ¬m khoáº£ng cÃ¡ch ngáº¯n nháº¥t tá»« má»¥c tiÃªu Ä‘áº¿n báº¥t ká»³ Ä‘iá»ƒm nÃ o trÃªn tuyáº¿n Ä‘Æ°á»ng
        currentRoute.forEach(routePoint => {
          const distance = calculateDistanceBetweenPoints(routePoint, target.coords);
          if (distance < minDistance) {
            minDistance = distance;
          }
        });
        
        return {
          name: target.name,
          coords: target.coords,
          distance: minDistance
        };
      });

      // Sáº¯p xáº¿p theo khoáº£ng cÃ¡ch tÄƒng dáº§n vÃ  láº¥y 5 má»¥c tiÃªu gáº§n nháº¥t
      const nearbyTargets = targetDistances
        .sort((a, b) => a.distance - b.distance)
        .slice(0, 5);

      if (nearbyTargets.length > 0) {
        nearbyTargets.forEach((target, index) => {
          // Táº¡o marker cho má»¥c tiÃªu gáº§n vá»›i label Ä‘á»™ng
          const marker = L.marker(target.coords, {
            icon: L.divIcon({
              className: 'custom-div-icon',
              html: `
                <div style="position: relative;">
                  <div style="background-color: #dc3545; width: 36px; height: 36px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; position: relative;" onmouseover="this.style.transform='scale(1.3)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.7)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.5)';">
                    <div style="font-size: 18px;">ğŸ¯</div>
                    <div style="position: absolute; top: -4px; right: -4px; background: #dc3545; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${index + 1}</div>
                  </div>
                </div>
              `,
              iconSize: [36, 36],
              iconAnchor: [18, 18]
            })
          }).addTo(map);
          
          // Táº¡o label riÃªng biá»‡t Ä‘á»ƒ cÃ³ thá»ƒ Ä‘iá»u chá»‰nh vá»‹ trÃ­ theo zoom
          const labelOffset = [
            { x: 40, y: -8 },   // Pháº£i
            { x: -40, y: -8 },  // TrÃ¡i
            { x: 0, y: 40 },    // DÆ°á»›i
            { x: 0, y: -40 },   // TrÃªn
            { x: 60, y: -20 }   // ChÃ©o pháº£i
          ];
          
          const offset = labelOffset[index % 5];
          
          // Táº¡o label Ä‘á»™ng
          const label = L.marker(target.coords, {
            icon: L.divIcon({
              className: 'label-icon',
              html: `
                <div style="background: ${index === 0 ? 'rgba(220,53,69,0.9)' : 'rgba(0,124,191,0.9)'}; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; white-space: nowrap; min-width: 140px; text-align: center; box-shadow: 0 3px 8px rgba(0,0,0,0.4); border: 2px solid white; transform: translate(${offset.x}px, ${offset.y}px);">${target.name}</div>
              `,
              iconSize: [0, 0],
              iconAnchor: [0, 0]
            })
          }).addTo(map);
          
          const distanceText = target.distance < 1000 ? 
            `${target.distance.toFixed(0)} m` : 
            `${(target.distance / 1000).toFixed(2)} km`;
          
          marker.bindPopup(`
            <div style="min-width: 280px; padding: 8px;">
              <h4 style="margin: 0 0 8px 0; color: ${index === 0 ? '#dc3545' : '#007cbf'}; font-size: 16px; border-bottom: 2px solid ${index === 0 ? '#dc3545' : '#007cbf'}; padding-bottom: 5px;">ğŸ¯ ${target.name}</h4>
              <p style="margin: 8px 0; font-size: 13px;"><strong>Khoáº£ng cÃ¡ch:</strong> ${distanceText}</p>
              <p style="margin: 8px 0; font-size: 13px;"><strong>Thá»© háº¡ng:</strong> ${index + 1}/5</p>
              <p style="margin: 8px 0; font-size: 13px;"><strong>Tá»a Ä‘á»™:</strong> ${target.coords[0].toFixed(6)}, ${target.coords[1].toFixed(6)}</p>
              <div style="margin-top: 10px; padding: 8px; background: ${index === 0 ? '#fff5f5' : '#f0f8ff'}; border-radius: 5px; font-size: 12px; color: #666; border-left: 4px solid ${index === 0 ? '#dc3545' : '#007cbf'};">
                <strong>ThÃ´ng tin:</strong><br>
                â€¢ Loáº¡i: Má»¥c tiÃªu gáº§n tuyáº¿n Ä‘Æ°á»ng<br>
                â€¢ Æ¯u tiÃªn: ${index === 0 ? 'Cao nháº¥t' : 'Cao'}<br>
                â€¢ Tráº¡ng thÃ¡i: Hoáº¡t Ä‘á»™ng
              </div>
            </div>
          `);
          
          nearbyTargetMarkers.push(marker);
          nearbyTargetMarkers.push(label);

          // ThÃªm vÃ o danh sÃ¡ch
          const listItem = document.createElement('div');
          listItem.className = 'legend-item';
          listItem.style.marginBottom = '8px';
          listItem.style.padding = '5px';
          listItem.style.backgroundColor = index === 0 ? '#e8f4fd' : '#f8f9fa';
          listItem.style.borderRadius = '3px';
          listItem.style.borderLeft = index === 0 ? '3px solid #007cbf' : '1px solid #ddd';
          listItem.style.cursor = 'pointer';
          
          listItem.onclick = () => {
            map.setView(target.coords, 18);
            marker.openPopup();
          };
          
          listItem.innerHTML = `
            <div style="display: flex; align-items: center;">
              <div class="legend-color" style="background: ${index === 0 ? '#dc3545' : '#007cbf'}; margin-right: 8px;"></div>
              <div>
                <div style="font-weight: 600; font-size: 12px;">${target.name}</div>
                <div style="font-size: 11px; color: #666;">Khoáº£ng cÃ¡ch: ${distanceText}</div>
              </div>
            </div>
          `;
          nearbyList.appendChild(listItem);
        });
        
        document.getElementById('nearbyInfo').style.display = 'block';
        updateStatus(`TÃ¬m tháº¥y ${nearbyTargets.length} má»¥c tiÃªu gáº§n tuyáº¿n Ä‘Æ°á»ng - Click vÃ o danh sÃ¡ch Ä‘á»ƒ xem chi tiáº¿t`);
      } else {
        nearbyList.innerHTML = '<p style="color: #666; font-style: italic;">KhÃ´ng tÃ¬m tháº¥y má»¥c tiÃªu gáº§n tuyáº¿n Ä‘Æ°á»ng.</p>';
        document.getElementById('nearbyInfo').style.display = 'block';
        updateStatus('KhÃ´ng tÃ¬m tháº¥y má»¥c tiÃªu gáº§n');
      }
    }

    // HÃ m hiá»ƒn thá»‹ táº¥t cáº£ má»¥c tiÃªu
    function showAllTargets() {
      // XÃ³a cÃ¡c marker cÅ©
      hideAllTargets();
      
      targets.forEach((target, index) => {
        // Táº¡o marker chÃ­nh vá»›i icon xÃ¡c Ä‘á»‹nh má»¥c tiÃªu mÃ u Ä‘á»
        const marker = L.marker(target.coords, {
          icon: L.divIcon({
            className: 'custom-div-icon',
            html: `
              <div style="background-color: #dc3545; width: 36px; height: 36px; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; position: relative;" onmouseover="this.style.transform='scale(1.3)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.7)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.5)';">
                <div style="font-size: 18px;">ğŸ¯</div>
                <div style="position: absolute; top: -4px; right: -4px; background: #dc3545; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${index + 1}</div>
              </div>
            `,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
          })
        }).addTo(map);
        
        // Táº¡o label riÃªng biá»‡t vá»›i offset Ä‘á»™ng vÃ  style rÃµ rÃ ng hÆ¡n
        const labelOffset = [
          { x: 40, y: -8 },   // Pháº£i
          { x: -40, y: -8 },  // TrÃ¡i
          { x: 0, y: 40 },    // DÆ°á»›i
          { x: 0, y: -40 }    // TrÃªn
        ];
        
        const offset = labelOffset[index % 4];
        
        // Táº¡o label Ä‘á»™ng vá»›i style rÃµ rÃ ng hÆ¡n
        const label = L.marker(target.coords, {
          icon: L.divIcon({
            className: 'label-icon',
            html: `
              <div style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; white-space: nowrap; min-width: 140px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 2px solid white; transform: translate(${offset.x}px, ${offset.y}px); text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${target.name}</div>
            `,
            iconSize: [0, 0],
            iconAnchor: [0, 0]
          })
        }).addTo(map);
        
        marker.bindPopup(`
          <div style="min-width: 280px; padding: 8px;">
            <h4 style="margin: 0 0 10px 0; color: #dc3545; font-size: 16px; border-bottom: 2px solid #dc3545; padding-bottom: 8px;">ğŸ¢ ${target.name}</h4>
            <p style="margin: 8px 0; font-size: 13px;"><strong>ID:</strong> ${index + 1}</p>
            <p style="margin: 8px 0; font-size: 13px;"><strong>Tá»a Ä‘á»™:</strong> ${target.coords[0].toFixed(6)}, ${target.coords[1].toFixed(6)}</p>
            <div style="margin-top: 12px; padding: 8px; background: #fff5f5; border-radius: 5px; font-size: 12px; color: #721c24; border-left: 4px solid #dc3545;">
              <strong>ThÃ´ng tin:</strong><br>
              â€¢ Loáº¡i: Má»¥c tiÃªu quan trá»ng<br>
              â€¢ Tráº¡ng thÃ¡i: Hoáº¡t Ä‘á»™ng<br>
              â€¢ Æ¯u tiÃªn: Cao<br>
              â€¢ ID: ${index + 1}
            </div>
          </div>
        `);
        
        targetMarkers.push(marker);
        targetMarkers.push(label);
      });
      
      updateStatus(`ÄÃ£ hiá»ƒn thá»‹ ${targets.length} má»¥c tiÃªu vá»›i style rÃµ rÃ ng`);
    }

    // HÃ m áº©n táº¥t cáº£ má»¥c tiÃªu
    function hideAllTargets() {
      targetMarkers.forEach(marker => map.removeLayer(marker));
      targetMarkers = [];
      hideNearbyTargets();
      updateStatus('ÄÃ£ áº©n táº¥t cáº£ má»¥c tiÃªu');
    }

    // HÃ m áº©n má»¥c tiÃªu gáº§n
    function hideNearbyTargets() {
      nearbyTargetMarkers.forEach(marker => map.removeLayer(marker));
      nearbyTargetMarkers = [];
    }

    // HÃ m lÆ°u tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i
    function saveCurrentRoute() {
      if (currentRoute.length < 2) {
        alert('Vui lÃ²ng váº½ tuyáº¿n Ä‘Æ°á»ng trÆ°á»›c khi lÆ°u!');
        return;
      }

      const startName = document.getElementById('startPoint').value || 'Äiá»ƒm báº¯t Ä‘áº§u';
      const endName = document.getElementById('endPoint').value || 'Äiá»ƒm káº¿t thÃºc';
      const blockName = document.getElementById('blockName').value || 'KhÃ´ng cÃ³ tÃªn khá»‘i';
      const routeType = document.getElementById('routeType').value;
      const routeColor = document.getElementById('routeColor').value;

      const routeData = {
        id: Date.now(),
        name: `${startName} â†’ ${endName}`,
        startPoint: startName,
        endPoint: endName,
        blockName: blockName,
        routeType: routeType,
        coordinates: [...currentRoute],
        distance: calculateDistance(currentRoute),
        timestamp: new Date().toISOString(),
        color: routeColor,
        metadata: {
          totalPoints: currentRoute.length,
          estimatedDuration: Math.round(calculateDistance(currentRoute) * 3), // phÃºt
          createdBy: 'á»¨ng dá»¥ng Váº½ Tuyáº¿n Ä‘Æ°á»ng',
          version: '2.0'
        }
      };

      allRoutes.push(routeData);
      updateRouteSelector();
      updateRoutesList();
      
      // LÆ°u vÃ o localStorage
      saveRoutesToStorage();
      
      // XÃ³a tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i Ä‘á»ƒ váº½ tuyáº¿n má»›i
      clearCurrentRoute();
      
      updateStatus(`ÄÃ£ lÆ°u tuyáº¿n Ä‘Æ°á»ng: ${routeData.name}`);
    }

    // HÃ m lÆ°u tuyáº¿n Ä‘Æ°á»ng vÃ o localStorage
    function saveRoutesToStorage() {
      try {
        localStorage.setItem('savedRoutes', JSON.stringify(allRoutes));
        console.log('ÄÃ£ lÆ°u tuyáº¿n Ä‘Æ°á»ng vÃ o localStorage');
      } catch (error) {
        console.error('Lá»—i khi lÆ°u vÃ o localStorage:', error);
      }
    }

    // HÃ m táº£i tuyáº¿n Ä‘Æ°á»ng tá»« localStorage
    function loadRoutesFromStorage() {
      try {
        const savedRoutes = localStorage.getItem('savedRoutes');
        if (savedRoutes) {
          allRoutes = JSON.parse(savedRoutes);
          updateRouteSelector();
          updateRoutesList();
          updateStatus(`ÄÃ£ táº£i ${allRoutes.length} tuyáº¿n Ä‘Æ°á»ng tá»« bá»™ nhá»›`);
        }
      } catch (error) {
        console.error('Lá»—i khi táº£i tá»« localStorage:', error);
      }
    }

    // HÃ m chuyá»ƒn Ä‘á»•i tuyáº¿n Ä‘Æ°á»ng
    function switchRoute() {
      const selector = document.getElementById('routeSelector');
      const selectedIndex = parseInt(selector.value);
      
      if (selectedIndex === -1) {
        clearCurrentRoute();
        return;
      }

      const selectedRoute = allRoutes[selectedIndex];
      if (selectedRoute) {
        // XÃ³a tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i
        clearCurrentRoute();
        
        // Hiá»ƒn thá»‹ tuyáº¿n Ä‘Æ°á»ng Ä‘Æ°á»£c chá»n
        currentRoute = [...selectedRoute.coordinates];
        currentRouteIndex = selectedIndex;
        
        // Cáº­p nháº­t form
        document.getElementById('startPoint').value = selectedRoute.startPoint;
        document.getElementById('endPoint').value = selectedRoute.endPoint;
        document.getElementById('blockName').value = selectedRoute.blockName;
        document.getElementById('routeType').value = selectedRoute.routeType;
        document.getElementById('routeColor').value = selectedRoute.color; // Cáº­p nháº­t mÃ u
        
        // Váº½ tuyáº¿n Ä‘Æ°á»ng
        drawRoute(selectedRoute.color);
        updateRouteInfo();
        
        updateStatus(`ÄÃ£ chuyá»ƒn sang tuyáº¿n Ä‘Æ°á»ng: ${selectedRoute.name}`);
      }
    }

    // HÃ m xÃ³a táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng
    function clearAllRoutes() {
      if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng Ä‘Ã£ lÆ°u?')) {
        allRoutes = [];
        clearCurrentRoute();
        updateRouteSelector();
        updateRoutesList();
        
        // XÃ³a khá»i localStorage
        localStorage.removeItem('savedRoutes');
        
        updateStatus('ÄÃ£ xÃ³a táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng');
      }
    }

    // HÃ m xuáº¥t tuyáº¿n Ä‘Æ°á»ng ra file JSON
    function exportRoutesToJSON() {
      if (allRoutes.length === 0) {
        alert('ChÆ°a cÃ³ tuyáº¿n Ä‘Æ°á»ng Ä‘á»ƒ xuáº¥t!');
        return;
      }
      
      const exportData = {
        exportInfo: {
          application: 'á»¨ng dá»¥ng Váº½ Tuyáº¿n Ä‘Æ°á»ng',
          version: '2.0',
          exportDate: new Date().toISOString(),
          totalRoutes: allRoutes.length,
          totalDistance: allRoutes.reduce((sum, route) => sum + route.distance, 0).toFixed(2)
        },
        routes: allRoutes
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `tuyen-duong-export-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      updateStatus(`ÄÃ£ xuáº¥t ${allRoutes.length} tuyáº¿n Ä‘Æ°á»ng ra file JSON`);
    }

    // HÃ m xÃ³a tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i
    function clearCurrentRoute() {
      if (routePolyline) {
        map.removeLayer(routePolyline);
        routePolyline = null;
      }
      
      routeMarkers.forEach(marker => map.removeLayer(marker));
      routeMarkers = [];
      
      currentRoute = [];
      currentRouteIndex = -1;
      updateRouteInfo();
    }

    // HÃ m váº½ tuyáº¿n Ä‘Æ°á»ng
    function drawRoute(color = '#ffc107') {
      if (currentRoute.length >= 2) {
        routePolyline = L.polyline(currentRoute, {
          color: color,
          weight: 5,
          opacity: 0.8,
          smoothFactor: 1
        }).addTo(map);

        // Váº½ marker cho tá»«ng Ä‘iá»ƒm
        currentRoute.forEach((coord, index) => {
          const marker = L.circleMarker(coord, {
            radius: index === 0 ? 8 : (index === currentRoute.length - 1 ? 8 : 4),
            fillColor: index === 0 ? '#28a745' : (index === currentRoute.length - 1 ? '#dc3545' : '#007cbf'),
            color: index === 0 ? '#1e7e34' : (index === currentRoute.length - 1 ? '#c82333' : '#005a8b'),
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map);
          
          routeMarkers.push(marker);
        });
      }
    }

    // HÃ m cáº­p nháº­t selector tuyáº¿n Ä‘Æ°á»ng
    function updateRouteSelector() {
      const selector = document.getElementById('routeSelector');
      selector.innerHTML = '<option value="-1">-- Chá»n tuyáº¿n Ä‘Æ°á»ng --</option>';
      
      allRoutes.forEach((route, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${route.name} (${route.distance.toFixed(2)} km)`;
        selector.appendChild(option);
      });
    }

    // HÃ m cáº­p nháº­t danh sÃ¡ch tuyáº¿n Ä‘Æ°á»ng
    function updateRoutesList() {
      const routesList = document.getElementById('routesList');
      const content = document.getElementById('routesListContent');
      
      if (allRoutes.length === 0) {
        routesList.style.display = 'none';
        return;
      }
      
      content.innerHTML = '';
      allRoutes.forEach((route, index) => {
        const routeItem = document.createElement('div');
        routeItem.className = 'legend-item';
        routeItem.style.marginBottom = '8px';
        routeItem.style.padding = '8px';
        routeItem.style.backgroundColor = '#f8f9fa';
        routeItem.style.borderRadius = '5px';
        routeItem.style.borderLeft = `3px solid ${route.color}`;
        routeItem.style.cursor = 'pointer';
        
        routeItem.onclick = () => {
          document.getElementById('routeSelector').value = index;
          switchRoute();
        };
        
        routeItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; font-size: 12px; color: ${route.color};">${route.name}</div>
              <div style="font-size: 11px; color: #666;">
                ${route.startPoint} â†’ ${route.endPoint}
              </div>
              <div style="font-size: 10px; color: #888;">
                ${route.distance.toFixed(2)} km â€¢ ${route.routeType} â€¢ ${new Date(route.timestamp).toLocaleString()}
              </div>
            </div>
            <div style="font-size: 10px; color: #999;">#${index + 1}</div>
          </div>
        `;
        
        content.appendChild(routeItem);
      });
      
      routesList.style.display = 'block';
    }

    // HÃ m táº¡o mÃ u ngáº«u nhiÃªn cho tuyáº¿n Ä‘Æ°á»ng
    function getRandomRouteColor() {
      const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // HÃ m tÃ­nh khoáº£ng cÃ¡ch giá»¯a 2 Ä‘iá»ƒm
    function calculateDistanceBetweenPoints(point1, point2) {
      const lat1 = point1[0];
      const lon1 = point1[1];
      const lat2 = point2[0];
      const lon2 = point2[1];
      
      const R = 6371000; // BÃ¡n kÃ­nh TrÃ¡i Äáº¥t (m)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    // Xá»­ lÃ½ sá»± kiá»‡n click
    map.on('click', function(e) {
      if (!isDrawingMode) return;
      
      const latlng = e.latlng;
      currentRoute.push([latlng.lat, latlng.lng]);
      
      const startName = document.getElementById('startPoint').value || 'Äiá»ƒm báº¯t Ä‘áº§u';
      const endName = document.getElementById('endPoint').value || 'Äiá»ƒm káº¿t thÃºc';
      
      // Äiá»ƒm Ä‘áº§u tiÃªn
      if (currentRoute.length === 1) {
        const marker = L.circleMarker(latlng, {
          radius: 8,
          fillColor: "#28a745",
          color: "#1e7e34",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map).bindPopup(`ğŸš€ ${startName}<br>Tá»a Ä‘á»™: ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`);
        
        routeMarkers.push(marker);
        updateStatus(`ÄÃ£ thÃªm Ä‘iá»ƒm báº¯t Ä‘áº§u: ${startName}`);
      }
      // Äiá»ƒm cuá»‘i
      else if (currentRoute.length >= 2) {
        // XÃ³a marker cuá»‘i cÅ©
        if (routeMarkers.length > 1) {
          map.removeLayer(routeMarkers[routeMarkers.length - 1]);
          routeMarkers.pop();
        }
        
        // ThÃªm marker trung gian náº¿u cÃ³
        if (currentRoute.length > 2) {
          const midMarker = L.circleMarker(latlng, {
            radius: 4,
            fillColor: "#007cbf",
            color: "#005a8b",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(map).bindPopup(`Äiá»ƒm ${currentRoute.length - 1}: ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`);
          
          routeMarkers.push(midMarker);
        }
        
        // ThÃªm marker cuá»‘i
        const endMarker = L.circleMarker(latlng, {
          radius: 8,
          fillColor: "#dc3545",
          color: "#c82333",
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map).bindPopup(`ğŸ ${endName}<br>Tá»a Ä‘á»™: ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`);
        
        routeMarkers.push(endMarker);
        updateStatus(`ÄÃ£ thÃªm Ä‘iá»ƒm káº¿t thÃºc: ${endName}`);
      }
      
      // Váº½ Ä‘Æ°á»ng
      if (currentRoute.length >= 2) {
        if (routePolyline) {
          map.removeLayer(routePolyline);
        }
        
        const selectedColor = document.getElementById('routeColor').value;
        
        // Táº¡o polyline vá»›i style nÃ¢ng cao
        routePolyline = L.polyline(currentRoute, {
          color: selectedColor,
          weight: 6,
          opacity: 0.9,
          smoothFactor: 1,
          dashArray: currentRoute.length > 5 ? '10, 5' : null, // Dotted line cho tuyáº¿n dÃ i
          lineCap: 'round',
          lineJoin: 'round'
        }).addTo(map).bindPopup(`
          <div style="min-width: 250px; padding: 8px;">
            <h4 style="margin: 0 0 8px 0; color: ${selectedColor}; border-bottom: 2px solid ${selectedColor}; padding-bottom: 5px;">
              ğŸ›£ï¸ Tuyáº¿n Ä‘Æ°á»ng
            </h4>
            <p style="margin: 6px 0;"><strong>ğŸ¯ Äiá»ƒm báº¯t Ä‘áº§u:</strong> ${startName}</p>
            <p style="margin: 6px 0;"><strong>ğŸ Äiá»ƒm káº¿t thÃºc:</strong> ${endName}</p>
            <p style="margin: 6px 0;"><strong>ğŸ“ Khoáº£ng cÃ¡ch:</strong> ${calculateDistance(currentRoute).toFixed(2)} km</p>
            <p style="margin: 6px 0;"><strong>ğŸ“ Sá»‘ Ä‘iá»ƒm:</strong> ${currentRoute.length}</p>
            <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
              <strong>ğŸ’¡ Tip:</strong> Click "âœ… HoÃ n thÃ nh tuyáº¿n" Ä‘á»ƒ xem thÃ´ng tin chi tiáº¿t
            </div>
          </div>
        `);
        
        // Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh view khi thÃªm Ä‘iá»ƒm má»›i
        if (currentRoute.length >= 2) {
          const bounds = L.latLngBounds(currentRoute);
          map.fitBounds(bounds, { 
            padding: [50, 50], // Padding lá»›n hÆ¡n Ä‘á»ƒ cÃ³ khÃ´ng gian
            maxZoom: 16, // Giá»›i háº¡n zoom tá»‘i Ä‘a Ä‘á»ƒ nhÃ¬n rÃµ Ä‘Æ°á»ng
            minZoom: 13, // Giá»›i háº¡n zoom tá»‘i thiá»ƒu Ä‘á»ƒ xem tá»•ng quan
            animate: true // ThÃªm animation mÆ°á»£t mÃ 
          });
        }
        
        // Tá»± Ä‘á»™ng tÃ¬m má»¥c tiÃªu gáº§n khi váº½ xong Ä‘Æ°á»ng
        if (currentRoute.length === 2) {
          setTimeout(() => {
            checkNearbyTargets();
            updateStatus('ÄÃ£ tá»± Ä‘á»™ng tÃ¬m má»¥c tiÃªu gáº§n tuyáº¿n Ä‘Æ°á»ng');
          }, 500);
        }
      }
      
      updateRouteInfo();
    });
    
    // HÃ m áº©n/hiá»‡n legend
    function toggleLegend() {
      const legendContent = document.getElementById('legendContent');
      const toggleBtn = document.querySelector('#legend button');
      
      if (legendContent.style.display === 'none') {
        legendContent.style.display = 'block';
        toggleBtn.textContent = 'ğŸ‘ï¸';
        toggleBtn.title = 'áº¨n chÃº thÃ­ch';
      } else {
        legendContent.style.display = 'none';
        toggleBtn.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        toggleBtn.title = 'Hiá»‡n chÃº thÃ­ch';
      }
    }
    
    // HÃ m cáº­p nháº­t vá»‹ trÃ­ label khi zoom thay Ä‘á»•i
    function updateLabelPositions() {
      const zoom = map.getZoom();
      const scale = Math.max(0.5, Math.min(2, zoom / 15)); // Scale tá»« 0.5 Ä‘áº¿n 2 dá»±a trÃªn zoom
      
      // Cáº­p nháº­t táº¥t cáº£ label icon
      document.querySelectorAll('.label-icon div').forEach(label => {
        const currentTransform = label.style.transform;
        const baseTransform = currentTransform.replace(/scale\([^)]*\)/g, '').trim();
        label.style.transform = `${baseTransform} scale(${scale})`;
      });
    }
    
    // HÃ m báº­t/táº¯t cháº¿ Ä‘á»™ tá»± Ä‘á»™ng hiá»ƒn thá»‹ má»¥c tiÃªu
    function toggleAutoShowTargets() {
      autoShowTargets = !autoShowTargets;
      const btn = document.getElementById('autoShowBtn');
      
      if (autoShowTargets) {
        btn.textContent = 'ğŸ” Tá»± Ä‘á»™ng hiá»ƒn thá»‹ má»¥c tiÃªu';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-info');
        updateStatus('ÄÃ£ báº­t cháº¿ Ä‘á»™ tá»± Ä‘á»™ng hiá»ƒn thá»‹ má»¥c tiÃªu');
      } else {
        btn.textContent = 'ğŸ” Tá»± Ä‘á»™ng hiá»ƒn thá»‹ má»¥c tiÃªu (Táº®T)';
        btn.classList.remove('btn-info');
        btn.classList.add('btn-warning');
        updateStatus('ÄÃ£ táº¯t cháº¿ Ä‘á»™ tá»± Ä‘á»™ng hiá»ƒn thá»‹ má»¥c tiÃªu');
      }
    }
    
    // HÃ m hiá»ƒn thá»‹ tá»•ng quan má»¥c tiÃªu
    function showTargetsOverview() {
      const center = map.getCenter();
      const zoom = map.getZoom();
      
      // TÃ­nh khoáº£ng cÃ¡ch tá»« trung tÃ¢m báº£n Ä‘á»“ Ä‘áº¿n cÃ¡c má»¥c tiÃªu
      const targetsWithDistance = targets.map(target => {
        const distance = calculateDistanceBetweenPoints([center.lat, center.lng], target.coords);
        return {
          ...target,
          distanceFromCenter: distance
        };
      }).sort((a, b) => a.distanceFromCenter - b.distanceFromCenter);
      
      // Táº¡o popup vá»›i thÃ´ng tin tá»•ng quan
      const overviewContent = `
        <div style="min-width: 350px; max-height: 400px; overflow-y: auto;">
          <h4 style="margin: 0 0 15px 0; color: #007cbf; border-bottom: 2px solid #007cbf; padding-bottom: 8px;">
            ğŸ“Š Tá»•ng quan má»¥c tiÃªu (${targets.length} má»¥c tiÃªu)
          </h4>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <p style="margin: 5px 0; font-size: 13px;"><strong>ğŸ“ Trung tÃ¢m báº£n Ä‘á»“:</strong> ${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}</p>
            <p style="margin: 5px 0; font-size: 13px;"><strong>ğŸ” Má»©c zoom:</strong> ${zoom}</p>
            <p style="margin: 5px 0; font-size: 13px;"><strong>ğŸ“ Khoáº£ng cÃ¡ch gáº§n nháº¥t:</strong> ${(targetsWithDistance[0].distanceFromCenter / 1000).toFixed(2)} km</p>
          </div>
          
          <div style="max-height: 250px; overflow-y: auto;">
            <h5 style="margin: 0 0 10px 0; color: #333;">ğŸ¯ Má»¥c tiÃªu gáº§n trung tÃ¢m:</h5>
            ${targetsWithDistance.slice(0, 10).map((target, index) => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px; margin: 2px 0; background: ${index < 3 ? '#e8f4fd' : '#f8f9fa'}; border-radius: 3px; border-left: 3px solid ${index < 3 ? '#007cbf' : '#ddd'};">
                <div>
                  <div style="font-weight: 600; font-size: 12px;">${target.name}</div>
                  <div style="font-size: 11px; color: #666;">${target.coords[0].toFixed(6)}, ${target.coords[1].toFixed(6)}</div>
                </div>
                <div style="font-size: 11px; color: #007cbf; font-weight: 600;">
                  ${(target.distanceFromCenter / 1000).toFixed(2)} km
                </div>
              </div>
            `).join('')}
          </div>
          
          <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 3px; font-size: 11px; color: #856404;">
            ğŸ’¡ <strong>Máº¹o:</strong> Click vÃ o má»¥c tiÃªu Ä‘á»ƒ xem chi tiáº¿t. Sá»­ dá»¥ng nÃºt "ğŸ” TÃ¬m má»¥c tiÃªu gáº§n" Ä‘á»ƒ tÃ¬m má»¥c tiÃªu gáº§n tuyáº¿n Ä‘Æ°á»ng.
          </div>
        </div>
      `;
      
      // Hiá»ƒn thá»‹ popup
      L.popup({
        maxWidth: 400,
        maxHeight: 500
      })
      .setLatLng(center)
      .setContent(overviewContent)
      .openOn(map);
      
      updateStatus(`ÄÃ£ hiá»ƒn thá»‹ tá»•ng quan ${targets.length} má»¥c tiÃªu`);
    }
    
    // HÃ m Ä‘iá»u chá»‰nh view Ä‘á»ƒ xem tá»•ng quan
    function fitToOverview() {
      // TÃ­nh bounds bao quanh táº¥t cáº£ má»¥c tiÃªu
      const targetCoords = targets.map(target => target.coords);
      const bounds = L.latLngBounds(targetCoords);
      
      // ThÃªm padding vÃ  Ä‘iá»u chá»‰nh view Ä‘á»ƒ nhÃ¬n rÃµ Ä‘Æ°á»ng
      map.fitBounds(bounds, {
        padding: [100, 100], // Padding lá»›n hÆ¡n Ä‘á»ƒ cÃ³ khÃ´ng gian
        maxZoom: 14, // Zoom tá»‘i Ä‘a Ä‘á»ƒ nhÃ¬n rÃµ Ä‘Æ°á»ng phá»‘
        minZoom: 11 // Zoom tá»‘i thiá»ƒu Ä‘á»ƒ xem tá»•ng quan
      });
      
      updateStatus('ÄÃ£ Ä‘iá»u chá»‰nh view Ä‘á»ƒ xem tá»•ng quan vá»›i Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng');
    }
    
    // HÃ m Ä‘iá»u chá»‰nh view Ä‘á»ƒ xem tuyáº¿n Ä‘Æ°á»ng
    function fitToRoute() {
      if (currentRoute.length >= 2) {
        const bounds = L.latLngBounds(currentRoute);
        const maxZoom = detailViewMode ? 18 : 16; // Zoom cao hÆ¡n náº¿u á»Ÿ cháº¿ Ä‘á»™ chi tiáº¿t
        map.fitBounds(bounds, {
          padding: [50, 50],
          maxZoom: maxZoom
        });
        updateStatus(`ÄÃ£ Ä‘iá»u chá»‰nh view Ä‘á»ƒ xem ${detailViewMode ? 'chi tiáº¿t' : 'tá»•ng quan'} tuyáº¿n Ä‘Æ°á»ng`);
      } else {
        alert('ChÆ°a cÃ³ tuyáº¿n Ä‘Æ°á»ng Ä‘á»ƒ xem!');
      }
    }
    
    // HÃ m reset view vá» máº·c Ä‘á»‹nh
    function resetView() {
      map.setView([21.0365, 105.8341], 15);
      updateStatus('ÄÃ£ reset view vá» máº·c Ä‘á»‹nh (tá»•ng quan)');
    }
    
    // HÃ m hoÃ n thÃ nh tuyáº¿n Ä‘Æ°á»ng
    function completeRoute() {
      if (currentRoute.length < 2) {
        alert('Vui lÃ²ng váº½ Ã­t nháº¥t 2 Ä‘iá»ƒm Ä‘á»ƒ hoÃ n thÃ nh tuyáº¿n Ä‘Æ°á»ng!');
        return;
      }
      
      // Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh view Ä‘á»ƒ bao quanh toÃ n bá»™ tuyáº¿n Ä‘Æ°á»ng
      const bounds = L.latLngBounds(currentRoute);
      map.fitBounds(bounds, {
        padding: [50, 50],
        maxZoom: 16,
        animate: true
      });
      
      // TÃ­nh toÃ¡n thÃ´ng tin tuyáº¿n Ä‘Æ°á»ng
      const distance = calculateDistance(currentRoute);
      const duration = Math.round(distance * 3); // Æ¯á»›c tÃ­nh thá»i gian (phÃºt)
      
      // Hiá»ƒn thá»‹ thÃ´ng tin chi tiáº¿t
      const routeInfo = `
        <div style="min-width: 300px; padding: 10px;">
          <h4 style="margin: 0 0 10px 0; color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 5px;">
            âœ… Tuyáº¿n Ä‘Æ°á»ng hoÃ n thÃ nh
          </h4>
          <p style="margin: 8px 0;"><strong>ğŸ“ Tá»•ng khoáº£ng cÃ¡ch:</strong> ${distance.toFixed(2)} km</p>
          <p style="margin: 8px 0;"><strong>â±ï¸ Thá»i gian Æ°á»›c tÃ­nh:</strong> ~${duration} phÃºt</p>
          <p style="margin: 8px 0;"><strong>ğŸ“ Sá»‘ Ä‘iá»ƒm:</strong> ${currentRoute.length}</p>
          <p style="margin: 8px 0;"><strong>ğŸ¯ Äiá»ƒm báº¯t Ä‘áº§u:</strong> ${document.getElementById('startPoint').value || 'ChÆ°a Ä‘áº·t tÃªn'}</p>
          <p style="margin: 8px 0;"><strong>ğŸ Äiá»ƒm káº¿t thÃºc:</strong> ${document.getElementById('endPoint').value || 'ChÆ°a Ä‘áº·t tÃªn'}</p>
          <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 5px; border-left: 4px solid #28a745;">
            <strong>ğŸ’¡ Gá»£i Ã½:</strong><br>
            â€¢ Sá»­ dá»¥ng "ğŸ’¾ LÆ°u tuyáº¿n hiá»‡n táº¡i" Ä‘á»ƒ lÆ°u tuyáº¿n Ä‘Æ°á»ng<br>
            â€¢ Sá»­ dá»¥ng "ğŸ” TÃ¬m má»¥c tiÃªu gáº§n" Ä‘á»ƒ tÃ¬m má»¥c tiÃªu dá»c tuyáº¿n<br>
            â€¢ Sá»­ dá»¥ng "ğŸ“„ Xuáº¥t JSON" Ä‘á»ƒ xuáº¥t dá»¯ liá»‡u
          </div>
        </div>
      `;
      
      // Hiá»ƒn thá»‹ popup thÃ´ng tin
      L.popup({
        maxWidth: 400,
        maxHeight: 500
      })
      .setLatLng(currentRoute[Math.floor(currentRoute.length / 2)]) // Hiá»ƒn thá»‹ á»Ÿ giá»¯a tuyáº¿n
      .setContent(routeInfo)
      .openOn(map);
      
      updateStatus(`âœ… ÄÃ£ hoÃ n thÃ nh tuyáº¿n Ä‘Æ°á»ng: ${distance.toFixed(2)} km, ${currentRoute.length} Ä‘iá»ƒm`);
    }
    
    // HÃ m chá»‰nh sá»­a tuyáº¿n Ä‘Æ°á»ng
    function editRoute() {
      if (currentRoute.length < 2) {
        alert('ChÆ°a cÃ³ tuyáº¿n Ä‘Æ°á»ng Ä‘á»ƒ chá»‰nh sá»­a!');
        return;
      }
      
      // Báº­t cháº¿ Ä‘á»™ váº½ Ä‘á»ƒ chá»‰nh sá»­a
      if (!isDrawingMode) {
        toggleDrawMode();
      }
      
      // Zoom vÃ o tuyáº¿n Ä‘Æ°á»ng Ä‘á»ƒ dá»… chá»‰nh sá»­a
      const bounds = L.latLngBounds(currentRoute);
      map.fitBounds(bounds, {
        padding: [30, 30],
        maxZoom: 18,
        animate: true
      });
      
      updateStatus('âœï¸ ÄÃ£ báº­t cháº¿ Ä‘á»™ chá»‰nh sá»­a - Click Ä‘á»ƒ thÃªm Ä‘iá»ƒm má»›i vÃ o tuyáº¿n Ä‘Æ°á»ng');
    }
    
    // HÃ m hiá»ƒn thá»‹ thá»‘ng kÃª tuyáº¿n Ä‘Æ°á»ng
    function showRouteStats() {
      if (currentRoute.length < 2) {
        alert('ChÆ°a cÃ³ tuyáº¿n Ä‘Æ°á»ng Ä‘á»ƒ thá»‘ng kÃª!');
        return;
      }
      
      const distance = calculateDistance(currentRoute);
      const duration = Math.round(distance * 3);
      const avgSpeed = 20; // km/h
      const fuelConsumption = (distance * 0.1).toFixed(2); // L/100km
      
      // TÃ­nh toÃ¡n cÃ¡c thá»‘ng kÃª chi tiáº¿t
      const segments = [];
      for (let i = 1; i < currentRoute.length; i++) {
        const segmentDistance = calculateDistanceBetweenPoints(currentRoute[i-1], currentRoute[i]);
        segments.push({
          from: i,
          to: i + 1,
          distance: segmentDistance / 1000 // km
        });
      }
      
      const longestSegment = segments.reduce((max, seg) => seg.distance > max.distance ? seg : max);
      const shortestSegment = segments.reduce((min, seg) => seg.distance < min.distance ? seg : min);
      
      const statsContent = `
        <div style="min-width: 350px; max-height: 500px; overflow-y: auto;">
          <h4 style="margin: 0 0 15px 0; color: #17a2b8; border-bottom: 2px solid #17a2b8; padding-bottom: 8px;">
            ğŸ“Š Thá»‘ng kÃª tuyáº¿n Ä‘Æ°á»ng
          </h4>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #1565c0;">ğŸ“ ThÃ´ng tin cÆ¡ báº£n</h5>
            <p style="margin: 5px 0;"><strong>Tá»•ng khoáº£ng cÃ¡ch:</strong> ${distance.toFixed(2)} km</p>
            <p style="margin: 5px 0;"><strong>Thá»i gian Æ°á»›c tÃ­nh:</strong> ~${duration} phÃºt</p>
            <p style="margin: 5px 0;"><strong>Sá»‘ Ä‘iá»ƒm:</strong> ${currentRoute.length}</p>
            <p style="margin: 5px 0;"><strong>Sá»‘ Ä‘oáº¡n:</strong> ${currentRoute.length - 1}</p>
          </div>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #f3e5f5; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #7b1fa2;">ğŸš— ThÃ´ng tin di chuyá»ƒn</h5>
            <p style="margin: 5px 0;"><strong>Tá»‘c Ä‘á»™ trung bÃ¬nh:</strong> ${avgSpeed} km/h</p>
            <p style="margin: 5px 0;"><strong>TiÃªu thá»¥ nhiÃªn liá»‡u:</strong> ~${fuelConsumption}L</p>
            <p style="margin: 5px 0;"><strong>Äoáº¡n dÃ i nháº¥t:</strong> ${longestSegment.distance.toFixed(2)} km (${longestSegment.from}â†’${longestSegment.to})</p>
            <p style="margin: 5px 0;"><strong>Äoáº¡n ngáº¯n nháº¥t:</strong> ${shortestSegment.distance.toFixed(2)} km (${shortestSegment.from}â†’${shortestSegment.to})</p>
          </div>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ¯ Äiá»ƒm quan trá»ng</h5>
            <p style="margin: 5px 0;"><strong>Äiá»ƒm báº¯t Ä‘áº§u:</strong> ${document.getElementById('startPoint').value || 'ChÆ°a Ä‘áº·t tÃªn'}</p>
            <p style="margin: 5px 0;"><strong>Äiá»ƒm káº¿t thÃºc:</strong> ${document.getElementById('endPoint').value || 'ChÆ°a Ä‘áº·t tÃªn'}</p>
            <p style="margin: 5px 0;"><strong>Äiá»ƒm trung gian:</strong> ${currentRoute.length - 2}</p>
          </div>
          
          <div style="padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
            <strong>ğŸ’¡ Gá»£i Ã½:</strong><br>
            â€¢ Sá»­ dá»¥ng "ğŸš€ Tá»‘i Æ°u tuyáº¿n" Ä‘á»ƒ tá»‘i Æ°u hÃ³a tuyáº¿n Ä‘Æ°á»ng<br>
            â€¢ Sá»­ dá»¥ng "ğŸ” TÃ¬m má»¥c tiÃªu gáº§n" Ä‘á»ƒ tÃ¬m Ä‘iá»ƒm dá»«ng<br>
            â€¢ Sá»­ dá»¥ng "ğŸ’¾ LÆ°u tuyáº¿n hiá»‡n táº¡i" Ä‘á»ƒ lÆ°u tuyáº¿n Ä‘Æ°á»ng
          </div>
        </div>
      `;
      
      // Hiá»ƒn thá»‹ popup thá»‘ng kÃª
      L.popup({
        maxWidth: 400,
        maxHeight: 600
      })
      .setLatLng(currentRoute[Math.floor(currentRoute.length / 2)])
      .setContent(statsContent)
      .openOn(map);
      
      updateStatus(`ğŸ“Š ÄÃ£ hiá»ƒn thá»‹ thá»‘ng kÃª tuyáº¿n Ä‘Æ°á»ng: ${distance.toFixed(2)} km, ${currentRoute.length} Ä‘iá»ƒm`);
    }
    
    // HÃ m tá»‘i Æ°u tuyáº¿n Ä‘Æ°á»ng
    function optimizeRoute() {
      if (currentRoute.length < 3) {
        alert('Cáº§n Ã­t nháº¥t 3 Ä‘iá»ƒm Ä‘á»ƒ tá»‘i Æ°u tuyáº¿n Ä‘Æ°á»ng!');
        return;
      }
      
      // Thuáº­t toÃ¡n tá»‘i Æ°u Ä‘Æ¡n giáº£n - sáº¯p xáº¿p láº¡i cÃ¡c Ä‘iá»ƒm trung gian
      const startPoint = currentRoute[0];
      const endPoint = currentRoute[currentRoute.length - 1];
      const middlePoints = currentRoute.slice(1, -1);
      
      // Sáº¯p xáº¿p cÃ¡c Ä‘iá»ƒm trung gian theo khoáº£ng cÃ¡ch tá»« Ä‘iá»ƒm báº¯t Ä‘áº§u
      middlePoints.sort((a, b) => {
        const distA = calculateDistanceBetweenPoints(startPoint, a);
        const distB = calculateDistanceBetweenPoints(startPoint, b);
        return distA - distB;
      });
      
      // Táº¡o tuyáº¿n Ä‘Æ°á»ng tá»‘i Æ°u
      const optimizedRoute = [startPoint, ...middlePoints, endPoint];
      
      // Cáº­p nháº­t tuyáº¿n Ä‘Æ°á»ng hiá»‡n táº¡i
      currentRoute = [...optimizedRoute];
      
      // Váº½ láº¡i tuyáº¿n Ä‘Æ°á»ng
      if (routePolyline) {
        map.removeLayer(routePolyline);
      }
      
      const selectedColor = document.getElementById('routeColor').value;
      routePolyline = L.polyline(currentRoute, {
        color: selectedColor,
        weight: 6,
        opacity: 0.9,
        smoothFactor: 1,
        dashArray: '15, 5', // Dotted line Ä‘á»ƒ phÃ¢n biá»‡t tuyáº¿n Ä‘Ã£ tá»‘i Æ°u
        lineCap: 'round',
        lineJoin: 'round'
      }).addTo(map);
      
      // Cáº­p nháº­t markers
      routeMarkers.forEach(marker => map.removeLayer(marker));
      routeMarkers = [];
      
      currentRoute.forEach((coord, index) => {
        const marker = L.circleMarker(coord, {
          radius: index === 0 ? 8 : (index === currentRoute.length - 1 ? 8 : 4),
          fillColor: index === 0 ? '#28a745' : (index === currentRoute.length - 1 ? '#dc3545' : '#007cbf'),
          color: index === 0 ? '#1e7e34' : (index === currentRoute.length - 1 ? '#c82333' : '#005a8b'),
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map);
        
        routeMarkers.push(marker);
      });
      
      // Äiá»u chá»‰nh view
      const bounds = L.latLngBounds(currentRoute);
      map.fitBounds(bounds, {
        padding: [50, 50],
        maxZoom: 16,
        animate: true
      });
      
      const originalDistance = calculateDistance(currentRoute);
      updateStatus(`ğŸš€ ÄÃ£ tá»‘i Æ°u tuyáº¿n Ä‘Æ°á»ng: ${originalDistance.toFixed(2)} km, ${currentRoute.length} Ä‘iá»ƒm (dotted line)`);
    }
    
    // HÃ m hiá»ƒn thá»‹ táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng
    function showAllRoutes() {
      if (allRoutes.length === 0) {
        alert('ChÆ°a cÃ³ tuyáº¿n Ä‘Æ°á»ng nÃ o Ä‘Æ°á»£c lÆ°u!');
        return;
      }
      
      // XÃ³a cÃ¡c polyline cÅ©
      hideAllRoutes();
      
      // Hiá»ƒn thá»‹ táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng vá»›i mÃ u sáº¯c khÃ¡c nhau
      allRoutes.forEach((route, index) => {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd', '#ff9f43', '#10ac84'];
        const routeColor = colors[index % colors.length];
        
        // Táº¡o polyline cho tuyáº¿n Ä‘Æ°á»ng
        const polyline = L.polyline(route.coordinates, {
          color: routeColor,
          weight: 4,
          opacity: 0.8,
          smoothFactor: 1,
          dashArray: '8, 4', // Dotted line Ä‘á»ƒ phÃ¢n biá»‡t vá»›i tuyáº¿n hiá»‡n táº¡i
          lineCap: 'round',
          lineJoin: 'round'
        }).addTo(map);
        
        // ThÃªm popup cho tuyáº¿n Ä‘Æ°á»ng
        polyline.bindPopup(`
          <div style="min-width: 280px; padding: 8px;">
            <h4 style="margin: 0 0 8px 0; color: ${routeColor}; border-bottom: 2px solid ${routeColor}; padding-bottom: 5px;">
              ğŸ›£ï¸ ${route.name}
            </h4>
            <p style="margin: 6px 0;"><strong>ğŸ¯ Äiá»ƒm báº¯t Ä‘áº§u:</strong> ${route.startPoint}</p>
            <p style="margin: 6px 0;"><strong>ğŸ Äiá»ƒm káº¿t thÃºc:</strong> ${route.endPoint}</p>
            <p style="margin: 6px 0;"><strong>ğŸ“ Khoáº£ng cÃ¡ch:</strong> ${route.distance.toFixed(2)} km</p>
            <p style="margin: 6px 0;"><strong>ğŸ“ Sá»‘ Ä‘iá»ƒm:</strong> ${route.coordinates.length}</p>
            <p style="margin: 6px 0;"><strong>ğŸ·ï¸ TÃªn khá»‘i:</strong> ${route.blockName}</p>
            <p style="margin: 6px 0;"><strong>ğŸš— Loáº¡i:</strong> ${route.routeType}</p>
            <p style="margin: 6px 0;"><strong>ğŸ“… NgÃ y táº¡o:</strong> ${new Date(route.timestamp).toLocaleString()}</p>
            <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
              <strong>ğŸ’¡ Tip:</strong> Click vÃ o tuyáº¿n Ä‘á»ƒ xem chi tiáº¿t. Sá»­ dá»¥ng selector Ä‘á»ƒ chuyá»ƒn Ä‘á»•i tuyáº¿n.
            </div>
          </div>
        `);
        
        // ThÃªm markers cho Ä‘iá»ƒm báº¯t Ä‘áº§u vÃ  káº¿t thÃºc
        const startMarker = L.circleMarker(route.coordinates[0], {
          radius: 6,
          fillColor: '#28a745',
          color: '#1e7e34',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map).bindPopup(`ğŸ¯ Báº¯t Ä‘áº§u: ${route.startPoint}`);
        
        const endMarker = L.circleMarker(route.coordinates[route.coordinates.length - 1], {
          radius: 6,
          fillColor: '#dc3545',
          color: '#c82333',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        }).addTo(map).bindPopup(`ğŸ Káº¿t thÃºc: ${route.endPoint}`);
        
        allRoutePolylines.push(polyline, startMarker, endMarker);
      });
      
      allRoutesVisible = true;
      
      // Äiá»u chá»‰nh view Ä‘á»ƒ bao quanh táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng
      const allCoords = allRoutes.flatMap(route => route.coordinates);
      const bounds = L.latLngBounds(allCoords);
      map.fitBounds(bounds, {
        padding: [50, 50],
        maxZoom: 15,
        animate: true
      });
      
      updateStatus(`ğŸ—ºï¸ ÄÃ£ hiá»ƒn thá»‹ ${allRoutes.length} tuyáº¿n Ä‘Æ°á»ng vá»›i mÃ u sáº¯c khÃ¡c nhau`);
    }
    
    // HÃ m áº©n táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng
    function hideAllRoutes() {
      allRoutePolylines.forEach(polyline => map.removeLayer(polyline));
      allRoutePolylines = [];
      allRoutesVisible = false;
      updateStatus('ğŸ™ˆ ÄÃ£ áº©n táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng');
    }
    
    // HÃ m hiá»ƒn thá»‹ tá»•ng quan táº¥t cáº£ tuyáº¿n Ä‘Æ°á»ng
    function showRoutesOverview() {
      if (allRoutes.length === 0) {
        alert('ChÆ°a cÃ³ tuyáº¿n Ä‘Æ°á»ng nÃ o Ä‘á»ƒ xem tá»•ng quan!');
        return;
      }
      
      // TÃ­nh toÃ¡n thá»‘ng kÃª tá»•ng quan
      const totalDistance = allRoutes.reduce((sum, route) => sum + route.distance, 0);
      const totalPoints = allRoutes.reduce((sum, route) => sum + route.coordinates.length, 0);
      const avgDistance = totalDistance / allRoutes.length;
      const avgPoints = totalPoints / allRoutes.length;
      
      // TÃ¬m tuyáº¿n Ä‘Æ°á»ng dÃ i nháº¥t vÃ  ngáº¯n nháº¥t
      const longestRoute = allRoutes.reduce((max, route) => route.distance > max.distance ? route : max);
      const shortestRoute = allRoutes.reduce((min, route) => route.distance < min.distance ? route : min);
      
      // Thá»‘ng kÃª theo loáº¡i tuyáº¿n Ä‘Æ°á»ng
      const routeTypes = {};
      allRoutes.forEach(route => {
        routeTypes[route.routeType] = (routeTypes[route.routeType] || 0) + 1;
      });
      
      // Thá»‘ng kÃª theo khá»‘i
      const blockNames = {};
      allRoutes.forEach(route => {
        const blockName = route.blockName || 'KhÃ´ng cÃ³ tÃªn khá»‘i';
        blockNames[blockName] = (blockNames[blockName] || 0) + 1;
      });
      
      const overviewContent = `
        <div style="min-width: 400px; max-height: 600px; overflow-y: auto;">
          <h4 style="margin: 0 0 15px 0; color: #17a2b8; border-bottom: 2px solid #17a2b8; padding-bottom: 8px;">
            ğŸ“Š Tá»•ng quan tuyáº¿n Ä‘Æ°á»ng (${allRoutes.length} tuyáº¿n)
          </h4>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #1565c0;">ğŸ“ Thá»‘ng kÃª tá»•ng quan</h5>
            <p style="margin: 5px 0;"><strong>Tá»•ng khoáº£ng cÃ¡ch:</strong> ${totalDistance.toFixed(2)} km</p>
            <p style="margin: 5px 0;"><strong>Tá»•ng sá»‘ Ä‘iá»ƒm:</strong> ${totalPoints}</p>
            <p style="margin: 5px 0;"><strong>Khoáº£ng cÃ¡ch trung bÃ¬nh:</strong> ${avgDistance.toFixed(2)} km</p>
            <p style="margin: 5px 0;"><strong>Sá»‘ Ä‘iá»ƒm trung bÃ¬nh:</strong> ${avgPoints.toFixed(1)}</p>
          </div>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #f3e5f5; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #7b1fa2;">ğŸ† Tuyáº¿n Ä‘Æ°á»ng Ä‘áº·c biá»‡t</h5>
            <p style="margin: 5px 0;"><strong>DÃ i nháº¥t:</strong> ${longestRoute.name} (${longestRoute.distance.toFixed(2)} km)</p>
            <p style="margin: 5px 0;"><strong>Ngáº¯n nháº¥t:</strong> ${shortestRoute.name} (${shortestRoute.distance.toFixed(2)} km)</p>
            <p style="margin: 5px 0;"><strong>Nhiá»u Ä‘iá»ƒm nháº¥t:</strong> ${allRoutes.reduce((max, route) => route.coordinates.length > max.coordinates.length ? route : max).name} (${allRoutes.reduce((max, route) => route.coordinates.length > max.coordinates.length ? route : max).coordinates.length} Ä‘iá»ƒm)</p>
          </div>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸš— PhÃ¢n loáº¡i theo loáº¡i tuyáº¿n</h5>
            ${Object.entries(routeTypes).map(([type, count]) => 
              `<p style="margin: 5px 0;"><strong>${type}:</strong> ${count} tuyáº¿n</p>`
            ).join('')}
          </div>
          
          <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #856404;">ğŸ·ï¸ PhÃ¢n loáº¡i theo khá»‘i</h5>
            ${Object.entries(blockNames).map(([block, count]) => 
              `<p style="margin: 5px 0;"><strong>${block}:</strong> ${count} tuyáº¿n</p>`
            ).join('')}
          </div>
          
          <div style="padding: 10px; background: #f8d7da; border-radius: 5px; border-left: 4px solid #dc3545;">
            <strong>ğŸ’¡ Gá»£i Ã½:</strong><br>
            â€¢ Sá»­ dá»¥ng "ğŸ—ºï¸ Hiá»ƒn thá»‹ táº¥t cáº£ tuyáº¿n" Ä‘á»ƒ xem trÃªn báº£n Ä‘á»“<br>
            â€¢ Sá»­ dá»¥ng "âš–ï¸ So sÃ¡nh tuyáº¿n" Ä‘á»ƒ so sÃ¡nh chi tiáº¿t<br>
            â€¢ Sá»­ dá»¥ng "ğŸ“„ Xuáº¥t JSON" Ä‘á»ƒ xuáº¥t dá»¯ liá»‡u
          </div>
        </div>
      `;
      
      // Hiá»ƒn thá»‹ popup tá»•ng quan
      L.popup({
        maxWidth: 450,
        maxHeight: 700
      })
      .setLatLng(map.getCenter())
      .setContent(overviewContent)
      .openOn(map);
      
      updateStatus(`ğŸ“Š ÄÃ£ hiá»ƒn thá»‹ tá»•ng quan ${allRoutes.length} tuyáº¿n Ä‘Æ°á»ng`);
    }
    
    // HÃ m so sÃ¡nh tuyáº¿n Ä‘Æ°á»ng
    function compareRoutes() {
      if (allRoutes.length < 2) {
        alert('Cáº§n Ã­t nháº¥t 2 tuyáº¿n Ä‘Æ°á»ng Ä‘á»ƒ so sÃ¡nh!');
        return;
      }
      
      // Táº¡o báº£ng so sÃ¡nh
      const compareContent = `
        <div style="min-width: 500px; max-height: 600px; overflow-y: auto;">
          <h4 style="margin: 0 0 15px 0; color: #6f42c1; border-bottom: 2px solid #6f42c1; padding-bottom: 8px;">
            âš–ï¸ So sÃ¡nh tuyáº¿n Ä‘Æ°á»ng (${allRoutes.length} tuyáº¿n)
          </h4>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
              <thead>
                <tr style="background: #6f42c1; color: white;">
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">TÃªn tuyáº¿n</th>
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Khoáº£ng cÃ¡ch</th>
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Sá»‘ Ä‘iá»ƒm</th>
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Loáº¡i</th>
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Khá»‘i</th>
                  <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">NgÃ y táº¡o</th>
                </tr>
              </thead>
              <tbody>
                ${allRoutes.map((route, index) => `
                  <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : '#ffffff'};">
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #6f42c1;">${route.name}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${route.distance.toFixed(2)} km</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${route.coordinates.length}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${route.routeType}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${route.blockName || '-'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${new Date(route.timestamp).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
            <h5 style="margin: 0 0 10px 0; color: #1565c0;">ğŸ“Š Thá»‘ng kÃª so sÃ¡nh</h5>
            <p style="margin: 5px 0;"><strong>Tuyáº¿n dÃ i nháº¥t:</strong> ${allRoutes.reduce((max, route) => route.distance > max.distance ? route : max).name} (${allRoutes.reduce((max, route) => route.distance > max.distance ? route : max).distance.toFixed(2)} km)</p>
            <p style="margin: 5px 0;"><strong>Tuyáº¿n ngáº¯n nháº¥t:</strong> ${allRoutes.reduce((min, route) => route.distance < min.distance ? route : min).name} (${allRoutes.reduce((min, route) => route.distance < min.distance ? route : min).distance.toFixed(2)} km)</p>
            <p style="margin: 5px 0;"><strong>ChÃªnh lá»‡ch:</strong> ${(allRoutes.reduce((max, route) => route.distance > max.distance ? route : max).distance - allRoutes.reduce((min, route) => route.distance < min.distance ? route : min).distance).toFixed(2)} km</p>
          </div>
          
          <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
            <strong>ğŸ’¡ Gá»£i Ã½:</strong><br>
            â€¢ Click vÃ o tÃªn tuyáº¿n Ä‘á»ƒ chuyá»ƒn Ä‘á»•i vÃ  xem chi tiáº¿t<br>
            â€¢ Sá»­ dá»¥ng "ğŸ—ºï¸ Hiá»ƒn thá»‹ táº¥t cáº£ tuyáº¿n" Ä‘á»ƒ xem trÃªn báº£n Ä‘á»“<br>
            â€¢ Sá»­ dá»¥ng "ğŸ“„ Xuáº¥t JSON" Ä‘á»ƒ xuáº¥t dá»¯ liá»‡u so sÃ¡nh
          </div>
        </div>
      `;
      
      // Hiá»ƒn thá»‹ popup so sÃ¡nh
      L.popup({
        maxWidth: 600,
        maxHeight: 700
      })
      .setLatLng(map.getCenter())
      .setContent(compareContent)
      .openOn(map);
      
      updateStatus(`âš–ï¸ ÄÃ£ hiá»ƒn thá»‹ so sÃ¡nh ${allRoutes.length} tuyáº¿n Ä‘Æ°á»ng`);
    }
    
    // HÃ m báº­t/táº¯t cháº¿ Ä‘á»™ xem chi tiáº¿t
    function toggleDetailView() {
      detailViewMode = !detailViewMode;
      const btn = document.getElementById('detailViewBtn');
      
      if (detailViewMode) {
        btn.textContent = 'ğŸ” Cháº¿ Ä‘á»™ chi tiáº¿t (Báº¬T)';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-warning');
        map.setZoom(17);
        updateStatus('ÄÃ£ báº­t cháº¿ Ä‘á»™ xem chi tiáº¿t - Zoom cao hÆ¡n');
      } else {
        btn.textContent = 'ğŸ” Cháº¿ Ä‘á»™ chi tiáº¿t';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        map.setZoom(15);
        updateStatus('ÄÃ£ táº¯t cháº¿ Ä‘á»™ xem chi tiáº¿t - Zoom tá»•ng quan');
      }
    }
    
    // HÃ m báº­t/táº¯t cháº¿ Ä‘á»™ hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng
    function toggleStreetView() {
      streetViewMode = !streetViewMode;
      const btn = document.getElementById('streetViewBtn');
      
      if (streetViewMode) {
        btn.textContent = 'ğŸ›£ï¸ Hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng (Báº¬T)';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        map.setZoom(14); // Zoom Ä‘á»ƒ nhÃ¬n rÃµ Ä‘Æ°á»ng phá»‘
        updateStatus('ÄÃ£ báº­t cháº¿ Ä‘á»™ hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng');
      } else {
        btn.textContent = 'ğŸ›£ï¸ Hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
        map.setZoom(12); // Zoom xa hÆ¡n Ä‘á»ƒ xem tá»•ng quan
        updateStatus('ÄÃ£ táº¯t cháº¿ Ä‘á»™ hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng');
      }
    }
    
    // Khá»Ÿi táº¡o
    updateStatus('Sáºµn sÃ ng váº½ tuyáº¿n Ä‘Æ°á»ng');
    loadRoutesFromStorage(); // Táº£i dá»¯ liá»‡u tá»« localStorage khi khá»Ÿi Ä‘á»™ng
    
    // Khá»Ÿi táº¡o máº·c Ä‘á»‹nh khÃ´ng hiá»ƒn thá»‹ má»¥c tiÃªu
    setTimeout(() => {
      // Máº·c Ä‘á»‹nh báº­t cháº¿ Ä‘á»™ hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng
      const streetBtn = document.getElementById('streetViewBtn');
      streetBtn.textContent = 'ğŸ›£ï¸ Hiá»ƒn thá»‹ Ä‘Æ°á»ng phá»‘ rÃµ rÃ ng (Báº¬T)';
      streetBtn.classList.remove('btn-primary');
      streetBtn.classList.add('btn-success');
      
      updateStatus('Sáºµn sÃ ng váº½ tuyáº¿n Ä‘Æ°á»ng - Má»¥c tiÃªu sáº½ hiá»ƒn thá»‹ khi tÃ¬m kiáº¿m');
    }, 1000);
    
    // ThÃªm event listener cho zoom Ä‘á»ƒ cáº­p nháº­t label
    map.on('zoomend', updateLabelPositions);
    map.on('moveend', updateLabelPositions);
  </script>
</body>
</html>
